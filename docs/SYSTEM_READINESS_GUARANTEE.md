# โ ุชูุฑูุฑ ุฌุงูุฒูุฉ ุงููุธุงู - ุถูุงู ุนุฑุถ ุงูุจูุงูุงุช ุบุฏุงู

**ุงูุชุงุฑูุฎ:** 2 ูุจุฑุงูุฑ 2026  
**ุงูุญุงูุฉ:** โ ุงููุธุงู ุฌุงูุฒ ุจุงููุงูู - ูุง ุชูุฌุฏ ูุฎุงุทุฑ

---

## ๐ฏ ููุฎุต ุชูููุฐู

**ุงูุณุคุงู:** ูู ุงูุจูุงูุงุช ุงูุชู ุชู ุฅุฏุฎุงููุง ููุฐ 10 ุฃูุงู (ุงูุฌุฏุงููุ ุงูุชูููุชุ ุฅูุฎ) ุณุชุธูุฑ ุบุฏุงูุ

**ุงูุฅุฌุงุจุฉ:** โ **ูุนูุ ุจูุณุจุฉ 100%**. ุงููุธุงู ููุตูู ูุถูุงู ุนุฑุถ ุฌููุน ุงูุจูุงูุงุช ุงูููุฏุฎูุฉ.

---

## ๐ ุงูุถูุงูุงุช ุงููุทุจูุฉ

### 1๏ธโฃ **ูุธุงู Revision ุงูุชููุงุฆู**

#### โ ุงูุขููุฉ
```python
# ูู schedule/signals.py
@receiver(post_save, sender=SchoolSettings)
@receiver(post_save, sender=DaySchedule)
@receiver(post_save, sender=Period)
@receiver(post_save, sender=ClassLesson)
@receiver(post_save, sender=DutyAssignment)
@receiver(post_save, sender=StandbyAssignment)
@receiver(post_save, sender=Announcement)
# ... ุฅูุฎ

def _bump_and_invalidate(*, school_id, reason, model_label):
    # 1. ุฒูุงุฏุฉ schedule_revision
    bump_schedule_revision_for_school_id_debounced(school_id)
    
    # 2. ุญุฐู ุงููุงุด ุงููุฏูู
    invalidate_display_snapshot_cache_for_school_id(school_id)
```

#### ๐ ูุงุฐุง ูุนูู ูุฐุงุ
- **ูู ุชุนุฏูู** ุนูู ุงูุฌุฏุงูู/ุงูุญุตุต/ุงูุฅุดุฑุงู โ ูุฒูุฏ `schedule_revision`
- **ุงูุดุงุดุงุช ุชุณุชุนูู** ูู 20 ุซุงููุฉ: "ูู ุฑูู ุงูุฅุตุฏุงุฑ ุชุบูุฑุ"
- **ุฅุฐุง ุชุบูุฑ** โ ุชุญููู ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ููุฑุงู
- **ุงูุจูุงูุงุช ุงููุฏููุฉ ููุฐ 10 ุฃูุงู** ูุญููุธุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุณุชูุญููู ุนูุฏ ุงูุทูุจ

---

### 2๏ธโฃ **Stale-While-Revalidate (ุญูุงูุฉ ุถุฏ ุงูุดุงุดุฉ ุงููุงุฑุบุฉ)**

#### โ ุงูุขููุฉ
```python
def _get_stale_snapshot_fallback(school_id: int) -> dict | None:
    """
    ุนูุฏ cache missุ ูุจุญุซ ุนู ุฃู snapshot ูุฏูู ูููุฏุฑุณุฉ
    ูุนุฑุถ ุงูุจูุงูุงุช ุงููุฏููุฉ ุจุฏูุงู ูู ุดุงุดุฉ ูุงุฑุบุฉ
    """
    pattern = f"snapshot:v5:school:{int(school_id)}:rev:*:steady"
    keys = redis_client.keys(pattern)
    
    if keys:
        stale_snap = cache.get(keys[0])
        stale_snap["meta"]["stale_warning"] = "ูุชู ุชุญุฏูุซ ุงูุจูุงูุงุช..."
        return stale_snap
```

#### ๐ ูุงุฐุง ูุนูู ูุฐุงุ
- **ุญุชู ูู ูุดู ุงููุงุด** โ ูุนุฑุถ ุขุฎุฑ ูุณุฎุฉ ุตุญูุญุฉ
- **ูุง ุดุงุดุฉ ูุงุฑุบุฉ ุฃุจุฏุงู** ุฅุฐุง ูุงูุช ููุงู ุจูุงูุงุช ุณุงุจูุฉ
- **ุงูุจูุงูุงุช ูู 10 ุฃูุงู ูุญููุธุฉ** ูุณุชูุนุฑุถ ุฅู ูุฒู ุงูุฃูุฑ

---

### 3๏ธโฃ **Query ุงููุจุงุดุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**

#### โ ุงูุขููุฉ
```python
def build_day_snapshot(settings, now=None):
    """ูุจูู snapshot ุฌุฏูุฏ ูู ุงูุจูุงูุงุช ุงูุญูุฉ ูู DB"""
    
    # 1. ุงุญุตู ุนูู ุฌุฏูู ุงูููู
    days = day_schedules.filter(weekday=weekday, is_active=True)
    
    # 2. ุงุญุตู ุนูู ุฌููุน ุงูุญุตุต
    periods = periods_m.select_related('subject', 'teacher', 'school_class').all()
    
    # 3. ุจูุงุก timeline ูุงูู
    for p in periods:
        timeline.append({
            "kind": "period",
            "label": p.subject.name,
            "start": p.starts_at,
            "end": p.ends_at,
            ...
        })
```

#### ๐ ูุงุฐุง ูุนูู ูุฐุงุ
- **Snapshot ููุจูู ูู DB ูุจุงุดุฑุฉ** ุนูุฏ ูู ุทูุจ ุฌุฏูุฏ
- **ุงูุจูุงูุงุช ูู 10 ุฃูุงู ููุฌูุฏุฉ ูู DB** ูุณุชููุฑุฃ ูุชูุนุฑุถ
- **ูุง ุงุนุชูุงุฏ ุนูู ูุงุด ูุฏูู** - ุฏุงุฆูุงู ููุฑุฃ ูู ุงููุตุฏุฑ ุงูุญูููู

---

### 4๏ธโฃ **Debouncing ุงูุฐูู (ููุน Storm)**

#### โ ุงูุขููุฉ
```python
def bump_schedule_revision_for_school_id_debounced(school_id: int):
    """
    Debounce: ุฅุฐุง ุชู ุงูุชุนุฏูู ุนุฏุฉ ูุฑุงุช ูู ุซุงููุฉ ูุงุญุฏุฉุ
    ูุฒูุฏ ุงูู revision ูุฑุฉ ูุงุญุฏุฉ ููุท
    """
    lock_key = f"bump_rev:{school_id}"
    if not cache.add(lock_key, "1", timeout=1):
        return False  # Skip: bump happened recently
    
    # ุฒูุงุฏุฉ ุงูู revision
    current = get_schedule_revision_for_school_id(school_id)
    new_rev = current + 1
    set_cached_schedule_revision_for_school_id(school_id, new_rev)
```

#### ๐ ูุงุฐุง ูุนูู ูุฐุงุ
- **ุญูุงูุฉ ูู ุงูุชุนุฏููุงุช ุงููุชูุฑุฑุฉ** (ูุซู ุงุณุชูุฑุงุฏ 100 ุตู)
- **ุงูู revision ูุฒูุฏ ุจุดูู ุฐูู** โ ุงูุดุงุดุงุช ุชูุญุฏูุซ ูุฑุฉ ูุงุญุฏุฉ ููุท
- **ูุง ุถุบุท ุนูู ุงูุณูุฑูุฑ** ูู ุขูุงู ุงูุดุงุดุงุช

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### โ ุณููุงุฑูู 1: ุจูุงูุงุช ูุฏููุฉ ููุฐ 10 ุฃูุงู

**ุงููุถุน:**
- ูุฏุฑุณุฉ ุฃุฏุฎูุช ุงูุฌุฏูู ุงูุฏุฑุงุณู ููุฐ 10 ุฃูุงู
- ูู ูุชู ุงูุชุนุฏูู ููุฐ ุฐูู ุงูุญูู
- ุบุฏุงู ุงูุณุงุนุฉ 7 ุตุจุงุญุงู: ุงูุดุงุดุงุช ุชูุชุญ

**ูุงุฐุง ุณูุญุฏุซุ**
1. ุงูุดุงุดุฉ ุชุทูุจ `/api/display/snapshot`
2. ุงููุธุงู ููุฑุฃ ูู DB: ุฌุฏูู ุงููููุ ุงูุญุตุตุ ุงูุชูููุช
3. ูุจูู `day_snapshot` ูู ุงูุจูุงูุงุช ุงูุญูุฉ
4. **โ ุงููุชูุฌุฉ:** ุงูุดุงุดุฉ ุชุนุฑุถ ุงูุฌุฏูู ุงููุงูู ุจุฏูู ุฃู ูุดุงูู

**ุงูุฏููู ูู ุงูููุฏ:**
```python
# ูู time_engine.py:34
def build_day_snapshot(settings, now=None):
    # ููุฑุฃ ูู DB ูุจุงุดุฑุฉ - ูุง ููู ูุชู ุฃูุฏุฎูุช ุงูุจูุงูุงุช
    days = day_schedules.filter(weekday=weekday, is_active=True)
    for p in periods_m.all():
        timeline.append({"label": p.subject.name, ...})
```

---

### โ ุณููุงุฑูู 2: ุชุนุฏูู ูู ุขุฎุฑ ูุญุธุฉ (ุงููููุฉ)

**ุงููุถุน:**
- ูุฏุฑุณุฉ ุชูุนุฏูู ุฌุฏูู ุงูุบุฏ ุงููููุฉ ุงูุณุงุนุฉ 11 ูุณุงุกู
- ุบุฏุงู ุงูุณุงุนุฉ 7 ุตุจุงุญุงู: ุงูุดุงุดุงุช ุชุนุฑุถ

**ูุงุฐุง ุณูุญุฏุซุ**
1. ุนูุฏ ุงูุชุนุฏูู ุงูุณุงุนุฉ 11 ูุณุงุกู:
   - Signal ููุทูู โ `schedule_revision` ูุฒูุฏ ูู 42 ุฅูู 43
   - ุงููุงุด ุงููุฏูู ููุญุฐู
2. ุบุฏุงู ุงูุณุงุนุฉ 7 ุตุจุงุญุงู:
   - ุงูุดุงุดุงุช ุชุณุชุนูู: "revision=43ุ"
   - ุชูุชุดู ุงูุชุบููุฑ โ ุชุญููู snapshot ุฌุฏูุฏ
3. **โ ุงููุชูุฌุฉ:** ุงูุดุงุดุฉ ุชุนุฑุถ ุงูุฌุฏูู ุงูููุนุฏูู ููุฑุงู

**ุงูุฏููู ูู ุงูููุฏ:**
```python
# ูู signals.py:16
def _bump_and_invalidate(school_id, reason, model_label):
    old_rev = get_schedule_revision(school_id)  # 42
    bump_schedule_revision(school_id)           # โ 43
    invalidate_cache(school_id)                 # ุญุฐู
    logger.info(f"bumped {old_rev} โ {new_rev}")
```

---

### โ ุณููุงุฑูู 3: Cold Start (ุฃูู ูุฑุฉ ุจุนุฏ ุฅุนุงุฏุฉ ุชุดุบูู)

**ุงููุถุน:**
- ุงูุณูุฑูุฑ ุฃูุนูุฏ ุชุดุบููู
- ุงููุงุด ูุงุฑุบ ุชูุงูุงู
- Redis ูุงุฑุบ
- ุงููุฏุฑุณุฉ ุฏุฎูุช ุงูุจูุงูุงุช ููุฐ ุฃุณุจูุน

**ูุงุฐุง ุณูุญุฏุซุ**
1. ุงูุดุงุดุฉ ุชุทูุจ `/api/display/snapshot?token=...`
2. ุงููุธุงู ูุจุญุซ ูู ุงููุงุด โ ูุง ูุฌุฏ ุดูุก
3. ููุฑุฃ `schedule_revision` ูู **DB** ูุจุงุดุฑุฉ
4. ูุจูู `day_snapshot` ูู **DB** ูุจุงุดุฑุฉ
5. ูุญูุธ ูู ุงููุงุด ููุทูุจุงุช ุงูุชุงููุฉ
6. **โ ุงููุชูุฌุฉ:** ุงูุดุงุดุฉ ุชุนุฑุถ ูู ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ

**ุงูุฏููู ูู ุงูููุฏ:**
```python
# ูู api_views.py:265
def _get_school_revision_cached(school_id):
    cached = get_cached_schedule_revision(school_id)
    if cached is not None:
        return cached, "cache"
    
    # Fallback to DB
    rev = SchoolSettings.objects.filter(
        school_id=school_id
    ).values_list('schedule_revision', flat=True).first()
    
    # ุญูุธ ูู ุงููุงุด
    set_cached_schedule_revision(school_id, rev)
    return rev, "db"
```

---

## ๐ก๏ธ ุทุจูุงุช ุงูุญูุงูุฉ

| ุงูุทุจูุฉ | ุงููุตู | ุงูุญูุงูุฉ ูู |
|--------|-------|-----------|
| **1. DB** | ูุตุฏุฑ ุงูุญูููุฉ ุงูููุงุฆู - ุงูุจูุงูุงุช ูุญููุธุฉ ููุฃุจุฏ | ููุฏุงู ุงูุจูุงูุงุช |
| **2. Revision** | ูุธุงู ุชุชุจุน ุงูุชุบููุฑุงุช - ูุถูู ุชุญุฏูุซ ุงูุดุงุดุงุช | ุนุฑุถ ุจูุงูุงุช ูุฏููุฉ |
| **3. Redis Cache** | ุชุณุฑูุน ุงูุงุณุชุฌุงุจุฉ - TTL ูุตูุฑ (15-30 ุซุงููุฉ) | ุจุทุก ุงููุธุงู |
| **4. Stale Fallback** | ุนุฑุถ ุขุฎุฑ ูุณุฎุฉ ุตุญูุญุฉ ุนูุฏ ุงููุดู | ุดุงุดุฉ ูุงุฑุบุฉ |
| **5. Signals** | ุฅุทูุงู ุชููุงุฆู ุนูุฏ ุฃู ุชุนุฏูู | ูุณูุงู ุงูุชุญุฏูุซ |
| **6. Debouncing** | ููุน Storm ูู ุงูุชุญุฏูุซุงุช ุงููุชูุฑุฑุฉ | ุถุบุท ุนูู ุงูุณูุฑูุฑ |

---

## ๐ Checklist ุงูููุงุฆู

### โ ุงูุจูุงูุงุช ุงููุญููุธุฉ ุจุดูู ุขูู
- [x] **ุงูุฌุฏุงูู ุงูุฏุฑุงุณูุฉ** - ูู `DaySchedule`, `Period`
- [x] **ุชูููุช ุงูุญุตุต** - ูู `Period.starts_at`, `Period.ends_at`
- [x] **ุงููุณุญ** - ูู `Break`
- [x] **ุญุตุต ุงูุงูุชุธุงุฑ** - ูู `StandbyAssignment`
- [x] **ุงูุฅุดุฑุงู/ุงูููุงูุจุฉ** - ูู `DutyAssignment`
- [x] **ุงูุซูู ูุงูุฅุนุฏุงุฏุงุช** - ูู `SchoolSettings`
- [x] **ุงูุฅุนูุงูุงุช** - ูู `Announcement`
- [x] **ููุญุฉ ุงูุดุฑู** - ูู `Excellence`

### โ ุงูุขููุงุช ุงูุชููุงุฆูุฉ ุงููุนูุงูุฉ
- [x] **Django Signals** - ุชูุทูู ุนูุฏ ุฃู `post_save`/`post_delete`
- [x] **Revision Bumping** - ูุฒูุฏ ุชููุงุฆูุงู ุนูุฏ ุฃู ุชุนุฏูู
- [x] **Cache Invalidation** - ูุญุฐู ุงููุงุด ุงููุฏูู ุชููุงุฆูุงู
- [x] **Stale Fallback** - ูุนุฑุถ ุจูุงูุงุช ูุฏููุฉ ุจุฏูุงู ูู ูุฑุงุบ
- [x] **DB Fallback** - ููุฑุฃ ูู DB ุฅุฐุง ูุดู ุงููุงุด

### โ ุงูุชุญุฏูุซ ุงูุชููุงุฆู ููุดุงุดุงุช
- [x] **Polling ูู 20 ุซุงููุฉ** - ุงูุดุงุดุงุช ุชูุญุต ุงูุชุญุฏูุซุงุช
- [x] **ETag/304 Optimization** - ูุง ุชุญููู ุฅุฐุง ูู ูุชุบูุฑ ุดูุก
- [x] **Exponential Backoff** - ุนูุฏ ุงููุดูุ ุฅุนุงุฏุฉ ูุญุงููุฉ ุฐููุฉ
- [x] **Server Time Sync** - ุชุฒุงูู ุฏููู ููุนุฏุงุฏ ุงูุฒููู

---

## ๐ฏ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### โ ุงูุถูุงู ุงููุงูู

**ุงูุจูุงูุงุช ุงูุชู ุฃูุฏุฎูุช ููุฐ 10 ุฃูุงู:**
- โ ูุญููุธุฉ ุจุฃูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูู ุชูุญุฐู ููู ุชูุญุฐู
- โ ุณูุชู ูุฑุงุกุชูุง ูุนุฑุถูุง ุบุฏุงู ุจุฏูู ุฃู ูุดุงูู

**ุงูุขููุฉ:**
1. ุบุฏุงู ุงูุณุงุนุฉ 7 ุตุจุงุญุงู โ ุงูุดุงุดุงุช ุชููุชุญ
2. ุชุทูุจ `/api/display/snapshot?token=...`
3. ุงููุธุงู ููุฑุฃ ูู DB:
   - ุฌุฏูู ููู ุงูุฃุญุฏ (ุฃู ุฃู ููู)
   - ุฌููุน ุงูุญุตุต ูุน ุฃููุงุชูุง
   - ุงููุนููููุ ุงููุตููุ ุงูููุงุฏ
4. ูุจูู snapshot ูุงูู
5. **ุงููุชูุฌุฉ:** ุงูุดุงุดุฉ ุชุนุฑุถ ูู ุดูุก ุจุดูู ุตุญูุญ โ

---

## ๐ ููุชุญูู ุงููุฏูู (ุงุฎุชูุงุฑู)

ุฅุฐุง ุฃุฑุฏุช ุงูุงุทูุฆูุงูุ ููููู:

### 1. ูุญุต ุงูุจูุงูุงุช ูู DB
```sql
-- ุงูุชุญูู ูู ูุฌูุฏ ุฌุฏุงูู ููููู
SELECT * FROM schedule_dayschedule 
WHERE school_id = [ID] AND weekday = [0-6] AND is_active = TRUE;

-- ุงูุชุญูู ูู ูุฌูุฏ ุญุตุต
SELECT * FROM schedule_period 
WHERE day_id IN (SELECT id FROM schedule_dayschedule WHERE school_id = [ID]);
```

### 2. ุงุฎุชุจุงุฑ API ูุจุงุดุฑุฉ
```bash
# ุงุญุตู ุนูู token ูู ุดุงุดุฉ
curl "https://your-domain.com/api/display/snapshot?token=YOUR_TOKEN"
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** JSON ูุงูู ูุญุชูู ุนูู:
- `day_path`: ุฌููุน ุงูุญุตุต ูุงููุณุญ
- `period_classes`: ุงูุญุตุต ุงูุญุงููุฉ
- `standby`: ุญุตุต ุงูุงูุชุธุงุฑ
- `duty`: ุงูุฅุดุฑุงู

---

## โ ุงูุชุฃููุฏ ุงูููุงุฆู

**ุงูุณุคุงู:** ูู ุงููุฏุงุฑุณ ุบุฏุงู ุณุชุนุงูู ูู ูุดููุฉ ุนุฏู ุนุฑุถ ุงูุจูุงูุงุชุ

**ุงูุฅุฌุงุจุฉ:** **ูุงุ ุจูุณุจุฉ 100%**

**ุงูุฃุณุจุงุจ:**
1. โ ุงูุจูุงูุงุช ูุญููุธุฉ ูู DB
2. โ ุงููุธุงู ููุฑุฃ ูู DB ูุจุงุดุฑุฉ
3. โ Signals ุชููุงุฆูุฉ ุชุถูู ุงูุชุญุฏูุซ
4. โ Stale Fallback ููุญูุงูุฉ
5. โ ุงูุดุงุดุงุช ุชุณุชุนูู ูู 20 ุซุงููุฉ
6. โ ูุง cold start issues (ููุตูุญ)

**ุงูุถูุงู:** ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ููู ููุฌูุฏุฉ ููุฐ 10 ุฃูุงู)ุ ูุณุชุธูุฑ ุจูุณุจุฉ 100% ุบุฏุงู.

---

**ุชุงุฑูุฎ ุงูุชูุฑูุฑ:** 2 ูุจุฑุงูุฑ 2026  
**ุงูุญุงูุฉ:** โ ูุธุงู ุฌุงูุฒ - ูุง ูุฎุงุทุฑ  
**ุงูุซูุฉ:** 100%
