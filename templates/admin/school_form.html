{% extends "dashboard/_base.html" %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}
{% block page_description %}
Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†ØµÙ‘Ø©.
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">

  <!-- Header -->
  <div class="rounded-3xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 p-6 shadow-sm">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-start gap-4">
        <div class="h-12 w-12 rounded-2xl bg-sky-100 text-sky-700 flex items-center justify-center text-2xl">
          ğŸ«
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">{{ title }}</h1>
          <p class="text-slate-600 mt-1 text-sm md:text-base leading-relaxed">
            Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©. Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ <span class="font-bold">Slug Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ ÙÙ‚Ø·</span> ÙˆØ±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
          </p>
          <div class="mt-3 inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-bold bg-emerald-50 text-emerald-700 border border-emerald-100">
            âœ… slug Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·
          </div>
        </div>
      </div>

      <a href="{% url 'dashboard:system_schools_list' %}"
         class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-2xl text-sm font-bold
                bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 shadow-sm">
        <span class="text-base">â†©</span>
        <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
      </a>
    </div>
  </div>

  <!-- Tips -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="text-sm font-extrabold text-slate-900">ğŸ¯ Ø§Ù„Ù‡Ø¯Ù</div>
      <div class="text-sm text-slate-600 mt-1 leading-relaxed">
        Ø±Ø§Ø¨Ø· Ø«Ø§Ø¨Øª ÙˆØ³Ù‡Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„ÙƒÙ„ Ù…Ø¯Ø±Ø³Ø©.
      </div>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="text-sm font-extrabold text-slate-900">ğŸ”¤ slug Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</div>
      <div class="text-sm text-slate-600 mt-1 leading-relaxed">
        Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©/Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·.
      </div>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="text-sm font-extrabold text-slate-900">ğŸ”— Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±</div>
      <div class="text-sm text-slate-600 mt-1 leading-relaxed">
        Ø²Ø± Ù†Ø³Ø® + ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø³Ø±Ø¹Ø©.
      </div>
    </div>
  </div>

  <!-- Form Card -->
  <div class="bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden">

    <div class="px-6 py-5 border-b border-slate-100 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-emerald-100 text-emerald-700 flex items-center justify-center">
          âœ…
        </div>
        <div>
          <p class="text-sm font-extrabold text-slate-900">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p>
          <p class="text-xs text-slate-500">ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù€ slug ÙØ±ÙŠØ¯ â€” ÙˆØ³ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.</p>
        </div>
      </div>

      <span class="hidden sm:inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-bold bg-slate-100 text-slate-700">
        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
        Ø­ÙØ¸ Ø¢Ù…Ù†
      </span>
    </div>

    <form method="post" enctype="multipart/form-data" class="p-6 space-y-6" id="schoolForm" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
      <div class="rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
        <div class="font-extrabold mb-1">ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸</div>
        {% for error in form.non_field_errors %}
          <p class="leading-relaxed">{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}

      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

        {% for field in form %}
          {% if field.name == "slug" %}
            <div class="md:col-span-2 space-y-2">
              <div class="flex items-center justify-between gap-3">
                <label class="block text-xs font-extrabold text-slate-700">
                  {{ field.label }}
                </label>
                <button type="button"
                        id="regenSlugBtn"
                        class="inline-flex items-center gap-2 text-xs font-extrabold px-3 py-1.5 rounded-full
                               bg-sky-50 text-sky-700 border border-sky-100 hover:bg-sky-100">
                  âœ¨ ØªÙˆÙ„ÙŠØ¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù…
                </button>
              </div>

              <div class="relative">
                {{ field }}
                <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400 text-xs font-mono">
                  english-slug
                </div>
              </div>

              <p class="text-[11px] text-slate-500">
                ÙŠÙÙˆÙ„Ù‘ÙØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ <span class="font-bold">Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø·</span> (Ø­Ø±ÙˆÙ/Ø£Ø±Ù‚Ø§Ù…/Ø´Ø±Ø·Ø© -). ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§.
              </p>

              {% if field.errors %}
                <p class="text-xs text-rose-600">
                  {% for error in field.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                </p>
              {% endif %}

              <!-- URL Preview -->
              <div class="mt-3 rounded-3xl border border-slate-200 bg-gradient-to-br from-slate-50 to-white p-5">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                  <div class="min-w-0 space-y-1">
                    <div class="text-xs font-extrabold text-slate-700">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</div>
                    <div class="rounded-2xl bg-white border border-slate-200 px-4 py-3 font-mono text-sm text-slate-800 break-all"
                         id="schoolUrlPreview"
                         aria-live="polite">â€”</div>
                    <div class="text-[11px] text-slate-500">
                      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ØªØºÙŠÙ‘Ø± Ù…Ø³Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ÙƒØŒ ØºÙŠÙ‘Ø± PATH_TEMPLATE ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª.
                    </div>
                  </div>

                  <div class="flex items-center gap-2 shrink-0">
                    <button type="button"
                            id="copySchoolUrl"
                            class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-2xl text-sm font-extrabold
                                   bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 shadow-sm">
                      ğŸ“‹ Ù†Ø³Ø®
                    </button>
                    <a href="#"
                       id="openSchoolUrl"
                       target="_blank"
                       rel="noopener"
                       class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-2xl text-sm font-extrabold
                              bg-gradient-to-r from-sky-600 to-sky-700 text-white shadow-sm hover:shadow-md">
                      ğŸ”— ÙØªØ­
                    </a>
                  </div>
                </div>

                <div id="copyHint" class="mt-3 hidden text-xs font-extrabold text-emerald-700">
                  âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                </div>
                <div id="copyError" class="mt-3 hidden text-xs font-extrabold text-rose-700">
                  âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® â€” Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¹Ù„Ø§Ù‡
                </div>
              </div>
            </div>

          {% else %}
            <div class="space-y-2">
              <label class="block text-xs font-extrabold text-slate-700">
                {{ field.label }}
              </label>

              {{ field }}

              {% if field.help_text %}
                <p class="text-[11px] text-slate-500">{{ field.help_text }}</p>
              {% endif %}

              {% if field.errors %}
                <p class="text-xs text-rose-600">
                  {% for error in field.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                </p>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-2">
        <a href="{% url 'dashboard:system_schools_list' %}"
           class="px-4 py-3 rounded-2xl text-sm font-extrabold text-slate-700 bg-slate-100 hover:bg-slate-200">
          Ø¥Ù„ØºØ§Ø¡
        </a>
        <button type="submit"
                class="px-6 py-3 rounded-2xl text-sm font-extrabold text-white
                       bg-gradient-to-r from-emerald-500 to-emerald-600
                       hover:from-emerald-600 hover:to-emerald-700 shadow-md hover:shadow-lg">
          Ø­ÙØ¸
        </button>
      </div>

      <!-- ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ widgets Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª -->
      <style>
        #schoolForm input[type="text"],
        #schoolForm input[type="email"],
        #schoolForm input[type="url"],
        #schoolForm input[type="number"],
        #schoolForm input[type="tel"],
        #schoolForm input[type="password"],
        #schoolForm select,
        #schoolForm textarea {
          width: 100%;
          border-radius: 16px;
          border: 1px solid rgb(226 232 240);
          background: rgb(255 255 255);
          padding: 12px 12px;
          font-size: 14px;
          line-height: 1.25rem;
          color: rgb(15 23 42);
          outline: none;
          transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
        }
        #schoolForm textarea { min-height: 120px; resize: vertical; }

        #schoolForm input:focus,
        #schoolForm select:focus,
        #schoolForm textarea:focus {
          border-color: rgb(56 189 248);
          box-shadow: 0 0 0 4px rgba(56, 189, 248, .18);
          background: rgb(248 250 252);
        }

        #schoolForm input[type="file"]{
          width:100%;
          border-radius:16px;
          border: 1px dashed rgb(203 213 225);
          padding: 12px;
          background: rgb(248 250 252);
        }

        #schoolForm input[type="checkbox"]{
          width: 18px;
          height: 18px;
          border-radius: 6px;
          border: 1px solid rgb(203 213 225);
        }
      </style>

      <!-- Link + English slug generator -->
      <script>
        (function () {
          "use strict";

          // âœ… ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø®ØªÙ„Ù Ø¹Ù†Ø¯Ùƒ
          // Ø£Ù…Ø«Ù„Ø©:
          // const PATH_TEMPLATE = "/display/{slug}/";
          // const PATH_TEMPLATE = "/s/{slug}/";
          const PATH_TEMPLATE = "/schools/{slug}/";

          const nameEl = document.getElementById("id_name");
          const slugEl = document.getElementById("id_slug");

          const previewEl = document.getElementById("schoolUrlPreview");
          const copyBtn = document.getElementById("copySchoolUrl");
          const openBtn = document.getElementById("openSchoolUrl");
          const copyHint = document.getElementById("copyHint");
          const copyError = document.getElementById("copyError");
          const regenBtn = document.getElementById("regenSlugBtn");

          const isSecure = "{{ request.is_secure|yesno:'1,0' }}" === "1";
          const origin = (isSecure ? "https://" : "http://") + "{{ request.get_host }}";

          // Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø³ slug ÙŠØ¯ÙˆÙŠÙ‹Ø§ØŸ
          let slugTouched = false;
          if (slugEl) {
            slugEl.addEventListener("input", function () {
              slugTouched = true;
              // Ù†Ø¸Ù‘Ù ÙÙˆØ±ÙŠÙ‹Ø§ Ù„ÙŠØ¨Ù‚Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
              slugEl.value = sanitizeEnglishSlug(slugEl.value);
              updatePreview();
            });
          }

          // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø§Øª Ø´Ø§Ø¦Ø¹Ø© Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
          function stripCommonWords(s) {
            const txt = String(s || "").trim();
            if (!txt) return "";
            // ÙƒÙ„Ù…Ø§Øª Ø´Ø§Ø¦Ø¹Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ/Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
            return txt
              .replace(/\b(school|schools)\b/ig, " ")
              .replace(/Ù…Ø¯Ø±Ø³Ø©|Ù…Ø¯Ø§Ø±Ø³/g, " ")
              .replace(/\s+/g, " ")
              .trim();
          }

          // transliteration Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø§ØªÙŠÙ†ÙŠØ© (Ù„Ø£Ø¬Ù„ slug ÙÙ‚Ø·)
          const AR_MAP = {
            "Ø§":"a","Ø£":"a","Ø¥":"i","Ø¢":"a","Ø¡":"", "Ø¤":"w","Ø¦":"y","Ù‰":"a",
            "Ø¨":"b","Øª":"t","Ø«":"th","Ø¬":"j","Ø­":"h","Ø®":"kh",
            "Ø¯":"d","Ø°":"dh","Ø±":"r","Ø²":"z","Ø³":"s","Ø´":"sh",
            "Øµ":"s","Ø¶":"d","Ø·":"t","Ø¸":"z","Ø¹":"a","Øº":"gh",
            "Ù":"f","Ù‚":"q","Ùƒ":"k","Ù„":"l","Ù…":"m","Ù†":"n","Ù‡":"h","Ùˆ":"w","ÙŠ":"y",
            "Ø©":"h"
          };

          function transliterateArabicToLatin(input) {
            const s = String(input || "");
            let out = "";
            for (const ch of s) {
              out += (AR_MAP[ch] !== undefined) ? AR_MAP[ch] : ch;
            }
            return out;
          }

          function sanitizeEnglishSlug(value) {
            let s = String(value || "").trim();

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
            s = s.replace(/[\u064B-\u065F]/g, "");

            // transliteration Ù„Ù„Ø¹Ø±Ø¨ÙŠ
            s = transliterateArabicToLatin(s);

            // normalize
            try { s = s.normalize("NFKD"); } catch (e) {}

            // Ø£Ø¨Ù‚Ù ÙÙ‚Ø·: a-z 0-9 ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§Øª/Ø§Ù„Ø´Ø±Ø·Ø§Øª
            s = s
              .toLowerCase()
              .replace(/[^a-z0-9\s-]/g, " ")
              .replace(/\s+/g, "-")
              .replace(/-+/g, "-")
              .replace(/^-|-$/g, "");

            // Ø­Ø¯ Ø·ÙˆÙ„ Ù…Ù†Ø·Ù‚ÙŠ
            if (s.length > 60) s = s.slice(0, 60).replace(/-+$/g, "");
            return s;
          }

          function randomSlug() {
            try {
              const arr = new Uint8Array(4);
              crypto.getRandomValues(arr);
              return Array.from(arr).map(b => b.toString(16).padStart(2, "0")).join("");
            } catch (e) {
              return String(Date.now()).slice(-8);
            }
          }

          function makeSlugFromName(name) {
            const base = stripCommonWords(name);
            let slug = sanitizeEnglishSlug(base);

            if (!slug) slug = "school-" + randomSlug();
            // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± prefix Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ø£ØµÙ„Ø§Ù‹ ÙŠØ¨Ø¯Ø£ Ø¨Ù‡
            slug = slug.replace(/^school-+school-+/g, "school-");
            return slug;
          }

          function buildUrl(slug) {
            const safe = String(slug || "").trim();
            if (!safe) return "";
            const path = PATH_TEMPLATE.replace("{slug}", encodeURIComponent(safe));
            return origin + path;
          }

          function updatePreview() {
            const slug = slugEl ? slugEl.value : "";
            const url = buildUrl(slug);

            if (previewEl) previewEl.textContent = url || "â€”";
            if (openBtn) {
              openBtn.href = url || "#";
              openBtn.classList.toggle("opacity-50", !url);
              openBtn.classList.toggle("pointer-events-none", !url);
            }
          }

          function regenerateFromName() {
            if (!slugEl) return;
            const nm = nameEl ? nameEl.value : "";
            const next = makeSlugFromName(nm);
            slugEl.value = next;
            slugTouched = false; // Ø§Ø¹ØªØ¨Ø±Ù‡ ØªÙˆÙ„ÙŠØ¯ Ø¢Ù„ÙŠ
            updatePreview();
          }

          // ØªÙˆÙ„ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… (Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯Ù„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§)
          if (nameEl && slugEl) {
            nameEl.addEventListener("input", function () {
              if (slugTouched) return;
              slugEl.value = makeSlugFromName(nameEl.value);
              updatePreview();
            });
          }

          if (regenBtn) {
            regenBtn.addEventListener("click", function () {
              regenerateFromName();
            });
          }

          if (copyBtn) {
            copyBtn.addEventListener("click", async function () {
              if (copyHint) copyHint.classList.add("hidden");
              if (copyError) copyError.classList.add("hidden");

              const slug = slugEl ? slugEl.value : "";
              const url = buildUrl(slug);
              if (!url) {
                if (copyError) copyError.classList.remove("hidden");
                return;
              }

              try {
                await navigator.clipboard.writeText(url);
                if (copyHint) copyHint.classList.remove("hidden");
                setTimeout(() => { if (copyHint) copyHint.classList.add("hidden"); }, 1800);
              } catch (e) {
                if (copyError) copyError.classList.remove("hidden");
              }
            });
          }

          // init
          // Ø¥Ø°Ø§ ÙƒØ§Ù† slug Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§ (ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯Ø±Ø³Ø©) Ù†Ø¸Ù‘ÙÙ‡ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠÙ‹Ø§ ÙˆØ­Ø¯Ø« Ø§Ù„Ø±Ø§Ø¨Ø·
          if (slugEl && slugEl.value) slugEl.value = sanitizeEnglishSlug(slugEl.value);
          // Ù„Ùˆ slug ÙØ§Ø¶ÙŠ ÙˆØ§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯: ÙˆÙ„Ù‘Ø¯
          if (slugEl && nameEl && !slugEl.value && nameEl.value) regenerateFromName();
          updatePreview();
        })();
      </script>

    </form>
  </div>

</div>
{% endblock %}
