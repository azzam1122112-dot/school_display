{% extends "dashboard/_base.html" %}

{% block title %}
  {% if is_create %}Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…{% else %}ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…{% endif %}
{% endblock %}

{% block page_title %}
  {% if is_create %}Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯{% else %}ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…{% endif %}
{% endblock %}

{% block page_description %}
  {% if is_create %}
    Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ù…Ø¯Ø§Ø±Ø³ ÙˆØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ù…Ø¹ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.
  {% else %}
    ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ØŒ ÙˆØ¶Ø¨Ø· ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.
  {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">

  <!-- Header Card -->
  <div class="rounded-3xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 p-6 shadow-sm">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-start gap-4">
        <div class="h-12 w-12 rounded-2xl bg-indigo-100 text-indigo-700 flex items-center justify-center text-2xl">
          ğŸ‘¤
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">
            {% if is_create %}Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯{% else %}ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…{% endif %}
          </h1>
          <p class="text-slate-600 mt-1 text-sm md:text-base leading-relaxed">
            {% if is_create %}
              Ø£Ù†Ø´Ø¦ Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ø¹Ø¨Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯Ø©.
            {% else %}
              Ø­Ø¯Ù‘Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§.
            {% endif %}
          </p>

          <div class="mt-3 flex flex-wrap gap-2">
            <span class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-extrabold bg-slate-100 text-slate-700">
              âœ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø§Ø±Ø³ Ù…ØªØ¹Ø¯Ø¯ Ø¨Ø¯ÙˆÙ† Ctrl
            </span>
            <span class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-extrabold bg-emerald-50 text-emerald-700 border border-emerald-100">
              ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
            </span>
          </div>
        </div>
      </div>

      <a href="{% url 'dashboard:system_users_list' %}"
         class="inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-2xl text-sm font-extrabold
                bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 shadow-sm">
        <span class="text-base">â†©</span>
        <span>Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</span>
      </a>
    </div>
  </div>

  <!-- Form -->
  <form method="post" class="bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden">
    {% csrf_token %}

    <!-- Top bar -->
    <div class="px-6 py-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-sky-100 text-sky-700 flex items-center justify-center">ğŸ›¡ï¸</div>
        <div>
          <div class="text-sm font-extrabold text-slate-900">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
          <div class="text-xs text-slate-500">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ØŒ Ø®ØµÙˆØµÙ‹Ø§ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¯Ø§Ø±Ø³.</div>
        </div>
      </div>

      <span class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-extrabold bg-slate-100 text-slate-700">
        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
        Ø­ÙØ¸ Ø¢Ù…Ù†
      </span>
    </div>

    <div class="p-6 space-y-6">

      {% if form.non_field_errors %}
        <div class="rounded-3xl border border-rose-200 bg-rose-50 px-5 py-4 text-sm text-rose-700">
          <div class="font-extrabold mb-1">ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸</div>
          {% for error in form.non_field_errors %}
            <div class="leading-relaxed">{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Sections grid -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- Main fields -->
        <div class="lg:col-span-7 space-y-5">

          <div class="rounded-3xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 p-5">
            <div class="flex items-center justify-between gap-3 mb-4">
              <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-2xl bg-indigo-100 text-indigo-700 flex items-center justify-center">ğŸ§¾</div>
                <div>
                  <div class="text-sm font-extrabold text-slate-900">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                  <div class="text-xs text-slate-500">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„Ø¨Ø±ÙŠØ¯/Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø§Ù„Ø­Ø§Ù„Ø©â€¦</div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              {% for field in form %}
                {% if field.name != "schools" %}
                  {% if "password" in field.name %}
                    {# Ø³Ù†Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù†ÙØµÙ„Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ #}
                  {% else %}
                    <div class="space-y-2">
                      <label class="block text-xs font-extrabold text-slate-700">{{ field.label }}</label>
                      {{ field }}
                      {% if field.help_text %}
                        <p class="text-[11px] text-slate-500">{{ field.help_text }}</p>
                      {% endif %}
                      {% if field.errors %}
                        <p class="text-xs text-rose-600">
                          {% for error in field.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                        </p>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <!-- Password card -->
          <div class="rounded-3xl border border-slate-200 bg-white p-5">
            <div class="flex items-start gap-3 mb-4">
              <div class="h-10 w-10 rounded-2xl bg-amber-100 text-amber-800 flex items-center justify-center">ğŸ”</div>
              <div>
                <div class="text-sm font-extrabold text-slate-900">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
                <div class="text-xs text-slate-500">
                  {% if is_create %}
                    Ø¹ÙŠÙ‘Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯.
                  {% else %}
                    Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ø¥Ù† ÙƒÙ†Øª Ù„Ø§ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
              {% for field in form %}
                {% if "password" in field.name %}
                  <div class="space-y-2">
                    <label class="block text-xs font-extrabold text-slate-700">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                      <p class="text-[11px] text-slate-500">{{ field.help_text }}</p>
                    {% endif %}
                    {% if field.errors %}
                      <p class="text-xs text-rose-600">
                        {% for error in field.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                      </p>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>

            <div class="mt-4 text-[11px] text-slate-500">
              {% if is_create %}
                Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£Ø¹Ù„Ø§Ù‡ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù†ÙØ³ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.
              {% else %}
                Ø§ØªØ±Ùƒ Ø­Ù‚ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ Ù„Ø§ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
              {% endif %}
            </div>
          </div>

        </div>

        <!-- Schools selector -->
        <div class="lg:col-span-5 space-y-5">

          <div class="rounded-3xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 p-5">
            <div class="flex items-start gap-3">
              <div class="h-10 w-10 rounded-2xl bg-emerald-100 text-emerald-700 flex items-center justify-center">ğŸ«</div>
              <div class="flex-1">
                <div class="text-sm font-extrabold text-slate-900">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§</div>
                <div class="text-xs text-slate-500 mt-1 leading-relaxed">
                  Ø§Ø®ØªØ± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø¯Ø±Ø³Ø© Ø¹Ø¨Ø± <span class="font-bold">checkbox</span> Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ctrl.
                </div>
              </div>
            </div>

            <!-- Search -->
            <div class="mt-4">
              <label class="block text-xs font-extrabold text-slate-700 mb-2">Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</label>
              <div class="relative">
                <input id="schoolsSearch" type="text"
                       class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm outline-none
                              focus:border-emerald-400 focus:ring-4 focus:ring-emerald-100"
                       placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù†Ù‡...">
                <div class="absolute inset-y-0 left-3 flex items-center text-slate-400">ğŸ”</div>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <button type="button" id="schoolsSelectAll"
                        class="px-3 py-1.5 rounded-full text-xs font-extrabold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50">
                  ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                </button>
                <button type="button" id="schoolsClearAll"
                        class="px-3 py-1.5 rounded-full text-xs font-extrabold bg-white border border-slate-200 text-slate-700 hover:bg-slate-50">
                  Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                </button>
                <span class="px-3 py-1.5 rounded-full text-xs font-extrabold bg-slate-100 text-slate-700">
                  Ø§Ù„Ù…Ø­Ø¯Ø¯: <span id="schoolsCount">0</span>
                </span>
              </div>
            </div>

            <!-- Field render (we will transform it to checkboxes via JS) -->
            <div class="mt-4">
              {% for field in form %}
                {% if field.name == "schools" %}
                  <label class="block text-xs font-extrabold text-slate-700 mb-2">{{ field.label }}</label>

                  <div id="schoolsNativeField" class="hidden">
                    {{ field }}
                  </div>

                  <!-- Our checkbox container -->
                  <div id="schoolsCheckboxes"
                       class="rounded-3xl border border-slate-200 bg-white p-3 max-h-[420px] overflow-auto">
                    <div class="text-sm text-slate-500 p-3">
                      Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³...
                    </div>
                  </div>

                  {% if field.help_text %}
                    <p class="text-[11px] text-slate-500 mt-2">{{ field.help_text }}</p>
                  {% endif %}

                  {% if field.errors %}
                    <p class="text-xs text-rose-600 mt-2">
                      {% for error in field.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                    </p>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </div>

          <div class="rounded-3xl border border-slate-200 bg-white p-5">
            <div class="text-sm font-extrabold text-slate-900">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
            <div class="text-sm text-slate-600 mt-1 leading-relaxed">
              Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù‡Ù†Ø§ØŒ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙÙˆØ±Ù… ÙŠØ­ØªÙˆÙŠ Ø­Ù‚Ù„ ManyToMany Ø¨Ø§Ø³Ù… <span class="font-mono font-bold">schools</span>.
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- Footer actions -->
    <div class="px-6 py-5 border-t border-slate-100 bg-slate-50 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="text-[11px] text-slate-500">
        Ø§Ù„Ø­ÙØ¸ ÙŠØ·Ø¨Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
      </div>
      <div class="flex gap-3">
        <a href="{% url 'dashboard:system_users_list' %}"
           class="px-5 py-2.5 rounded-2xl text-sm font-extrabold border border-slate-200 text-slate-700 bg-white hover:bg-slate-50">
          Ø¥Ù„ØºØ§Ø¡
        </a>
        <button type="submit"
                class="px-6 py-2.5 rounded-2xl text-sm font-extrabold text-white bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 shadow-md hover:shadow-lg">
          Ø­ÙØ¸
        </button>
      </div>
    </div>

    <!-- Local widget styling -->
    <style>
      #schoolForm input[type="text"],
      #schoolForm input[type="email"],
      #schoolForm input[type="url"],
      #schoolForm input[type="number"],
      #schoolForm input[type="tel"],
      #schoolForm input[type="password"],
      #schoolForm select,
      #schoolForm textarea {
        width: 100%;
        border-radius: 16px;
        border: 1px solid rgb(226 232 240);
        background: rgb(255 255 255);
        padding: 12px 12px;
        font-size: 14px;
        line-height: 1.25rem;
        color: rgb(15 23 42);
        outline: none;
        transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      }
      #schoolForm textarea { min-height: 120px; resize: vertical; }

      #schoolForm input:focus,
      #schoolForm select:focus,
      #schoolForm textarea:focus {
        border-color: rgb(99 102 241);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, .16);
        background: rgb(248 250 252);
      }

      #schoolForm input[type="checkbox"]{
        width: 18px;
        height: 18px;
        border-radius: 6px;
        border: 1px solid rgb(203 213 225);
      }
    </style>

    <script>
      (function () {
        "use strict";

        // âœ… Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³Ù… Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ø®ØªÙ„ÙÙ‹Ø§ ÙÙŠ Ø§Ù„ÙÙˆØ±Ù…
        const SCHOOLS_FIELD_NAME = "schools";

        const nativeWrap = document.getElementById("schoolsNativeField");
        const container = document.getElementById("schoolsCheckboxes");
        const searchEl = document.getElementById("schoolsSearch");
        const selectAllBtn = document.getElementById("schoolsSelectAll");
        const clearAllBtn = document.getElementById("schoolsClearAll");
        const countEl = document.getElementById("schoolsCount");

        if (!nativeWrap || !container) return;

        // Ø­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ select Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø­Ù‚Ù„
        const nativeSelect = nativeWrap.querySelector('select[name="' + SCHOOLS_FIELD_NAME + '"]')
                           || nativeWrap.querySelector('select[multiple]')
                           || nativeWrap.querySelector("select");

        if (!nativeSelect) return;

        // Ø§Ø¨Ù‚Ù Ø§Ù„Ù€ select Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ (Ù…Ø®ÙÙŠ) Ù„ÙŠÙØ±Ø³Ù„ ÙÙŠ POST Ø·Ø¨ÙŠØ¹ÙŠ
        nativeSelect.classList.add("hidden");

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        const options = Array.from(nativeSelect.options || []);
        const items = options.map(opt => ({
          value: opt.value,
          label: (opt.textContent || "").trim(),
          selected: opt.selected
        }));

        function render(list) {
          if (!list.length) {
            container.innerHTML = `
              <div class="p-4 text-sm text-slate-500">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.
              </div>
            `;
            updateCount();
            return;
          }

          container.innerHTML = list.map(item => {
            const safeLabel = escapeHtml(item.label || ("School " + item.value));
            return `
              <label class="flex items-center gap-3 p-3 rounded-2xl hover:bg-slate-50 border border-transparent hover:border-slate-200 transition">
                <input type="checkbox" class="school-cb" data-value="${escapeAttr(item.value)}" ${item.selected ? "checked" : ""}>
                <div class="min-w-0">
                  <div class="text-sm font-extrabold text-slate-900 truncate">${safeLabel}</div>
                  <div class="text-[11px] text-slate-500 font-mono truncate">id: ${escapeHtml(item.value)}</div>
                </div>
              </label>
            `;
          }).join("");

          // bind events
          container.querySelectorAll(".school-cb").forEach(cb => {
            cb.addEventListener("change", function () {
              const v = this.getAttribute("data-value");
              const opt = nativeSelect.querySelector('option[value="' + cssEscape(v) + '"]');
              if (opt) opt.selected = this.checked;
              updateCount();
            });
          });

          updateCount();
        }

        function updateCount() {
          const selectedCount = Array.from(nativeSelect.options).filter(o => o.selected).length;
          if (countEl) countEl.textContent = String(selectedCount);
        }

        function filter() {
          const q = (searchEl ? searchEl.value : "").trim().toLowerCase();
          if (!q) return items;

          return items.filter(it => (it.label || "").toLowerCase().includes(q));
        }

        // Select/Clear
        if (selectAllBtn) {
          selectAllBtn.addEventListener("click", function () {
            Array.from(nativeSelect.options).forEach(o => o.selected = true);
            items.forEach(i => i.selected = true);
            render(filter());
          });
        }

        if (clearAllBtn) {
          clearAllBtn.addEventListener("click", function () {
            Array.from(nativeSelect.options).forEach(o => o.selected = false);
            items.forEach(i => i.selected = false);
            render(filter());
          });
        }

        if (searchEl) {
          searchEl.addEventListener("input", function () {
            render(filter());
          });
        }

        // Utils
        function escapeHtml(s) {
          return String(s || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
        function escapeAttr(s) { return escapeHtml(s).replace(/"/g, "&quot;"); }
        function cssEscape(val) {
          // Ø¨Ø³ÙŠØ· ÙˆØ¢Ù…Ù† Ù„Ù…Ø¹Ø¸Ù… Ø§Ù„Ù‚ÙŠÙ… (ids ØºØ§Ù„Ø¨Ù‹Ø§ Ø£Ø±Ù‚Ø§Ù…)
          return String(val).replace(/"/g, '\\"');
        }

        // init
        render(items);
      })();
    </script>

  </form>

</div>
{% endblock %}
