{% extends "dashboard/_base.html" %}
{% load static %}

{% block title %}Ø§Ø´ØªØ±Ø§ÙƒÙŠ{% endblock %}
{% block page_title %}ØªÙØ§ØµÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©{% endblock %}
{% block page_description %}
Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ø´ØªØ±Ø§ÙƒØ§ØªÙƒØŒ ØªØ§Ø¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ØŒ ÙˆÙ‚Ù… Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©.
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8 animate-fade-in-up">

  {# --- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‡Ø§Ù…Ø© (Alerts Section) --- #}
  
  {# 1. ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø´ØªØ±Ø§Ùƒ Ù‚Ø§Ø¯Ù… #}
  {% if upcoming_subscription %}
    <div class="group relative overflow-hidden rounded-3xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 p-1 shadow-sm hover:shadow-md transition-all duration-300">
      <div class="absolute top-0 right-0 -mr-16 -mt-16 w-32 h-32 bg-amber-200/40 rounded-full blur-3xl group-hover:bg-amber-300/40 transition-colors"></div>
      <div class="relative flex flex-col sm:flex-row items-center sm:items-start gap-4 p-5 md:p-6">
        <div class="flex-shrink-0 w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-white text-amber-500 shadow-sm flex items-center justify-center text-2xl md:text-3xl ring-4 ring-amber-100">
          â³
        </div>
        <div class="flex-1 text-center sm:text-right space-y-1">
          <h4 class="font-bold text-amber-900 text-lg">Ø§Ø´ØªØ±Ø§Ùƒ Ù‚Ø§Ø¯Ù… ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h4>
          <p class="text-amber-800 text-sm md:text-base leading-relaxed">
            Ø³ÙŠØ¨Ø¯Ø£ ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ <span class="font-bold border-b border-amber-400/50">{{ upcoming_subscription.plan.name }}</span>
            Ø¨ØªØ§Ø±ÙŠØ® <span dir="ltr" class="font-mono font-bold bg-amber-100/50 px-1 rounded">{{ upcoming_subscription.display_starts_at|default:upcoming_subscription.starts_at }}</span>.
            {% if current_subscription %}
              Ø³ÙŠØ¨Ø¯Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙˆØ± Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  {% endif %}

  {# 2. Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ #}
  {% if current_subscription %}
    {% if current_status_code == "expired" %}
      <!-- Expired Alert -->
      <div class="rounded-3xl bg-gradient-to-br from-rose-600 to-red-600 text-white shadow-xl shadow-rose-200 overflow-hidden relative">
        <div class="absolute opacity-10 top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/diagonal-stripes.png')]"></div>
        <div class="relative p-6 md:p-8 flex flex-col md:flex-row items-center gap-6 text-center md:text-right">
          <div class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center text-4xl shadow-inner backdrop-blur-sm animate-pulse">
            âš ï¸
          </div>
          <div class="flex-1 space-y-2">
            <h3 class="text-2xl font-black tracking-tight">Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ!</h3>
            <p class="text-rose-100 text-sm md:text-lg font-medium opacity-90">
              ØªÙˆÙ‚ÙØª Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„. Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø¸Ù‡ÙˆØ± Ø´Ø§Ø´Ø© Ù…Ø¯Ø±Ø³ØªÙƒØŒ ÙŠØ±Ø¬Ù‰ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù†.
            </p>
          </div>
          <button onclick="document.getElementById('renewal-section').scrollIntoView({behavior: 'smooth'})" class="flex-shrink-0 bg-white text-rose-600 hover:bg-rose-50 px-6 py-3 rounded-xl font-bold shadow-lg transition transform hover:-translate-y-1 active:scale-95">
            ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù† âš¡
          </button>
        </div>
      </div>

    {% elif current_status_code == "cancelled" %}
      <!-- Cancelled Alert -->
      <div class="rounded-3xl bg-gradient-to-br from-slate-700 to-slate-900 text-white shadow-xl overflow-hidden relative border border-slate-600">
        <div class="relative p-6 md:p-8 flex flex-col md:flex-row items-center gap-6 text-center md:text-right">
          <div class="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center text-4xl shadow-inner backdrop-blur-sm">
            ğŸš«
          </div>
          <div class="flex-1 space-y-2">
            <h3 class="text-xl md:text-2xl font-black">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù„ØºÙŠ</h3>
            <p class="text-slate-300 text-sm md:text-base">
              ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø£Ùˆ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„.
            </p>
          </div>
          <button onclick="document.getElementById('renewal-section').scrollIntoView({behavior: 'smooth'})" class="flex-shrink-0 bg-white/10 hover:bg-white/20 text-white border border-white/30 px-6 py-3 rounded-xl font-bold transition">
            Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯
          </button>
        </div>
      </div>

    {% elif current_status_code == "active" %}
      <!-- Active Alert -->
      <div class="rounded-3xl bg-gradient-to-r from-emerald-600 to-teal-700 text-white shadow-lg shadow-emerald-200 relative overflow-hidden ring-1 ring-emerald-500/30">
        <!-- Decoration -->
        <div class="absolute -right-10 -top-10 w-40 h-40 bg-emerald-400/20 rounded-full blur-3xl mix-blend-overlay"></div>
        <div class="absolute -left-10 -bottom-10 w-40 h-40 bg-teal-900/30 rounded-full blur-3xl"></div>
        <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 mix-blend-overlay"></div>

        <div class="relative px-6 py-5 flex flex-col md:flex-row items-center md:items-center justify-between gap-4 text-center md:text-right">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-2xl backdrop-blur-md shadow-inner ring-1 ring-white/30">
              <span class="filter drop-shadow-sm">âœ¨</span>
            </div>
            <div>
              <h3 class="font-bold text-lg md:text-xl tracking-wide text-white drop-shadow-md">Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙØ¹Ù‘Ø§Ù„</h3>
              <p class="text-emerald-50 text-sm font-medium opacity-95 leading-snug">
                Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ©ØŒ Ø§Ø³ØªÙ…ØªØ¹ Ø¨ØªØ¬Ø±Ø¨Ø© Ù…Ù…ÙŠØ²Ø©.
              </p>
            </div>
          </div>
          
          {% if current_subscription.display_days_left is not None and current_subscription.display_days_left <= 7 %}
            <div class="bg-white/10 backdrop-blur-md px-5 py-2.5 rounded-xl border border-white/20 flex items-center gap-2 animate-pulse shadow-sm">
              <span class="text-lg">â³</span>
              <span class="font-bold text-sm text-white">Ù…ØªØ¨Ù‚ÙŠ {{ current_subscription.display_days_left }} ÙŠÙˆÙ…</span>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endif %}


  {# --- Ø¨Ø·Ø§Ù‚Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Main Subscription Card) --- #}
  {% if subscription %}
    <div class="bg-white rounded-[2rem] shadow-xl shadow-slate-200/60 border border-slate-100 overflow-hidden relative">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
      
      <div class="px-6 md:px-10 py-8">
        <div class="flex flex-col md:flex-row md:items-start justify-between gap-6 mb-8 border-b border-slate-100 pb-6">
          <div class="space-y-2">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 text-xs font-bold tracking-wide uppercase">
              Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            </div>
            <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900">
              {{ subscription.plan.name }}
            </h2>
            <p class="text-slate-500 text-sm">Ù…Ø¯Ø±Ø³Ø© {{ school.name }}</p>
          </div>
          
          <div class="flex flex-col items-center md:items-end gap-2 text-center md:text-left">
            <div class="px-4 py-1.5 rounded-full text-sm font-bold shadow-sm border 
              {% if current_status_code == 'active' %} bg-emerald-100 text-emerald-700 border-emerald-200
              {% elif current_status_code == 'expired' %} bg-rose-100 text-rose-700 border-rose-200
              {% else %} bg-slate-100 text-slate-700 border-slate-200 {% endif %}">
              <span class="w-2 h-2 rounded-full bg-current inline-block ml-1"></span>
              {{ current_status_label }}
            </div>
            <p class="text-xs text-slate-400 font-mono" dir="ltr">{{ today }}</p>
          </div>
        </div>

        <!-- Grid Info -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Start Date -->
          <div class="group p-5 rounded-2xl bg-slate-50 border border-slate-100 hover:bg-slate-100 hover:border-slate-200 transition-all duration-300">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-lg shadow-sm group-hover:scale-110 transition-transform">ğŸ“…</div>
              <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</p>
            </div>
            <p class="text-lg font-bold text-slate-800 font-mono">
              {{ subscription.display_starts_at|default:subscription.starts_at }}
            </p>
          </div>

          <!-- End Date -->
          <div class="group p-5 rounded-2xl bg-slate-50 border border-slate-100 hover:bg-slate-100 hover:border-slate-200 transition-all duration-300">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-lg shadow-sm group-hover:scale-110 transition-transform">ğŸ</div>
              <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</p>
            </div>
            <p class="text-lg font-bold text-slate-800 font-mono">
              {% if subscription.display_ends_at %}
                {{ subscription.display_ends_at }}
              {% else %}
                <span class="text-emerald-600">â™¾ï¸ Ù…ÙØªÙˆØ­ Ø§Ù„Ù…Ø¯Ø©</span>
              {% endif %}
            </p>
          </div>

          <!-- System Status -->
          <div class="group p-5 rounded-2xl bg-slate-50 border border-slate-100 hover:bg-slate-100 hover:border-slate-200 transition-all duration-300">
            <div class="flex items-center gap-3 mb-2">
              <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-lg shadow-sm group-hover:scale-110 transition-transform">ğŸ–¥ï¸</div>
              <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            </div>
            <p class="text-sm font-semibold text-slate-700 leading-snug">
               {% if current_subscription and current_status_code == "active" %}
                Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª ØªØ¹Ù…Ù„
              {% elif current_subscription and current_status_code == "expired" %}
                <span class="text-rose-600">Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…ØªÙˆÙ‚ÙØ©</span>
              {% else %}
                ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
              {% endif %}
            </p>
          </div>
        </div>

        {% if subscription.notes %}
          <div class="mt-6 p-4 rounded-xl bg-indigo-50/50 border border-indigo-100 text-sm text-indigo-900 flex gap-3">
            <span class="text-xl">ğŸ“</span>
            <p class="leading-relaxed">{{ subscription.notes }}</p>
          </div>
        {% endif %}
      </div>
    </div>
  {% else %}
    {# --- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø´ØªØ±Ø§Ùƒ (Empty State) --- #}
    <div class="relative bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-900 rounded-[2.5rem] shadow-2xl overflow-hidden text-white text-center py-20 px-8 border border-white/10">
      
      <!-- Background Shapes & Effects -->
      <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 mix-blend-overlay"></div>
      <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-indigo-600/30 rounded-full blur-[100px] -mr-20 -mt-20 mix-blend-screen animate-pulse-slow"></div>
      <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-purple-600/20 rounded-full blur-[100px] -ml-20 -mb-20 mix-blend-screen"></div>
      
      <div class="relative z-10 space-y-8 max-w-3xl mx-auto">
        <!-- Floating Icon -->
        <div class="inline-flex p-6 rounded-3xl bg-white/10 backdrop-blur-xl mb-4 shadow-2xl ring-1 ring-white/20 hover:scale-110 transition-transform duration-500">
          <span class="text-6xl filter drop-shadow-lg">ğŸš€</span>
        </div>
        
        <!-- Headlines -->
        <div class="space-y-4">
          <h2 class="text-4xl md:text-5xl font-black tracking-tight leading-tight">
            <span class="bg-clip-text text-transparent bg-gradient-to-b from-white to-indigo-200">
              Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø¢Ù†
            </span>
          </h2>
          <p class="text-indigo-100/90 text-lg md:text-xl leading-relaxed max-w-2xl mx-auto font-light">
            Ø­ÙˆÙ‘Ù„ Ø´Ø§Ø´Ø§Øª Ù…Ø¯Ø±Ø³ØªÙƒ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø¨Ù‡Ø±Ø©. <br class="hidden md:block" />
            Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„ØªÙŠ ØªÙ†Ø§Ø³Ø¨Ùƒ ÙˆØ§Ø³ØªÙ…ØªØ¹ Ø¨ØªØ¬Ø±Ø¨Ø© Ù„Ø§ Ù…Ø«ÙŠÙ„ Ù„Ù‡Ø§.
          </p>
        </div>

        <!-- CTA Button -->
        <div class="pt-6">
          <button onclick="document.getElementById('renewal-section').scrollIntoView({behavior: 'smooth'})" 
            class="group relative inline-flex items-center gap-3 bg-white text-indigo-950 hover:bg-indigo-50 px-10 py-5 rounded-2xl font-bold text-lg shadow-xl shadow-indigo-900/40 transform hover:-translate-y-1 hover:shadow-2xl transition-all duration-300 outline-none focus:ring-4 focus:ring-indigo-500/50">
            <span>Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
            <span class="text-xl transition-transform group-hover:-translate-x-1">â†</span>
          </button>
        </div>
      </div>
    </div>
  {% endif %}


  {# --- Ù‚Ø³Ù… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø¯ÙØ¹ (Renewal/Banking Section) --- #}
  <div id="renewal-section" class="grid grid-cols-1 lg:grid-cols-12 gap-8 pt-8">
    
    <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ© -->
    <div class="lg:col-span-5 space-y-6">
      <div class="space-y-2 mb-6">
        <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
          <span class="text-emerald-500">ğŸ¦</span>
          Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ
        </h3>
        <p class="text-sm text-slate-500">Ù‚Ù… Ø¨ØªØ­ÙˆÙŠÙ„ Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ.</p>
      </div>

      <!-- Credit Card Style -->
      <div class="relative w-full aspect-[1.586/1] rounded-3xl bg-gradient-to-br from-slate-800 to-black p-6 md:p-8 text-white shadow-2xl shadow-slate-400/50 overflow-hidden transform hover:scale-[1.01] transition-transform duration-500">
        <!-- Shine Effect -->
        <div class="absolute top-0 right-0 w-[150%] h-full bg-gradient-to-l from-transparent via-white/5 to-transparent -skew-x-12 translate-x-full animate-shimmer"></div>
        <div class="absolute -right-16 -top-16 w-64 h-64 bg-emerald-500/20 rounded-full blur-[80px]"></div>

        <div class="relative z-10 flex flex-col justify-between h-full">
          <div class="flex justify-between items-start">
            <div class="space-y-1">
              <p class="text-xs text-emerald-400 font-bold tracking-widest uppercase">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ</p>
              <h4 class="text-xl font-bold tracking-wide">Al Rajhi Bank</h4>
              <p class="text-[10px] text-slate-400">Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</p>
            </div>
            <!-- Chip Icon -->
            <div class="w-12 h-9 rounded bg-gradient-to-br from-amber-200 to-amber-400 border border-amber-500/50 flex relative overflow-hidden opacity-90">
               <div class="absolute top-1/2 left-0 w-full h-[1px] bg-amber-600/50"></div>
               <div class="absolute left-1/2 top-0 w-[1px] h-full bg-amber-600/50"></div>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <div class="flex justify-between items-end mb-1">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider">Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ¨Ø§Ù† (IBAN)</p>
                <button onclick="copyToClipboard('SA8580000660608016220957', this)" class="text-[10px] bg-white/10 hover:bg-white/20 px-2 py-1 rounded text-emerald-300 transition flex items-center gap-1 group">
                   <span class="copy-text">Ù†Ø³Ø®</span>
                   <span class="text-lg leading-none opacity-0 group-hover:opacity-100 transition-opacity">ğŸ“‹</span>
                </button>
              </div>
              <p class="font-mono text-sm md:text-lg tracking-wider text-slate-100 select-all" dir="ltr">SA85 8000 0660 6080 1622 0957</p>
            </div>
          </div>
          
          <div class="flex justify-between items-end">
             <div>
                <p class="text-[10px] text-slate-400 uppercase">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</p>
                <p class="font-medium text-sm md:text-base tracking-wide">MANSOUR ALGHAMDI</p>
             </div>
             <div>
                <p class="text-[10px] text-slate-400 uppercase text-right">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</p>
                <p class="font-mono font-bold text-sm select-all">660000010006086220957</p>
             </div>
          </div>
        </div>
      </div>

       <div class="rounded-xl bg-amber-50 border border-amber-100 p-4 flex items-center gap-3">
         <div class="text-lg">ğŸ’¡</div>
         <p class="text-xs text-amber-900 leading-relaxed">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØªÙ‚ÙˆÙ… Ø¨Ø±ÙØ¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙØ¹ÙŠÙ„.</p>
       </div>
    </div>


    <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±: Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨ -->
    <div class="lg:col-span-7 bg-white rounded-3xl shadow-lg border border-slate-100 p-6 md:p-8">
      
      <!-- Tabs Layout -->
      <div class="flex p-1.5 bg-slate-100 rounded-2xl mb-8">
        <button
          type="button"
          data-tab="renewal"
          class="request-tab-btn flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 text-center flex items-center justify-center gap-2"
        >
          <span>ğŸ”„</span> ØªØ¬Ø¯ÙŠØ¯ Ø§Ø´ØªØ±Ø§Ùƒ
        </button>
        <button
          type="button"
          data-tab="new"
          class="request-tab-btn flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 text-center flex items-center justify-center gap-2"
        >
          <span>âœ¨</span> Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>

      <!-- Tab Content: Renewal -->
        <div id="tab-renewal" class="{% if active_request_tab != 'renewal' %}hidden{% endif %} animate-fade-in">
          {% if subscription %}
            <div class="mb-6 p-4 bg-indigo-50 rounded-2xl border border-indigo-100 flex items-center justify-between">
               <div>
                 <p class="text-xs text-indigo-400 font-bold uppercase mb-1">Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                 <p class="text-lg font-bold text-indigo-900">{{ subscription.plan.name }}</p>
               </div>
               <div class="text-left">
                  {% if renewal_plan_details %}
                     <p class="text-2xl font-black text-indigo-700">{{ renewal_plan_details.price|default:"â€”" }} <span class="text-xs font-medium text-indigo-400">Ø±.Ø³</span></p>
                     <p class="text-[10px] text-indigo-400">Ù„Ù…Ø¯Ø© {{ renewal_plan_details.duration_days }} ÙŠÙˆÙ…</p>
                  {% endif %}
               </div>
            </div>

            <form method="post" enctype="multipart/form-data" class="space-y-5">
              {% csrf_token %}
              <input type="hidden" name="action" value="renewal">
              
              <div class="space-y-1">
                <label class="block text-sm font-bold text-slate-700">ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
                <div class="relative">
                   {{ renew_form.receipt_image }}
                   <!-- Custom file input styling can be added via JS or CSS, keeping default for compatibility but styled wrappers -->
                </div>
                <p class="text-[11px] text-slate-400">ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© (JPEG, PNG, PDF)</p>
                 {% if renew_form.receipt_image.errors %}
                   <p class="text-xs text-red-500 mt-1">{{ renew_form.receipt_image.errors }}</p>
                 {% endif %}
              </div>

               <div class="space-y-1">
                <label class="block text-sm font-bold text-slate-700">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                {{ renew_form.transfer_note }}
                 {% if renew_form.transfer_note.errors %}
                   <p class="text-xs text-red-500 mt-1">{{ renew_form.transfer_note.errors }}</p>
                 {% endif %}
              </div>

              <button type="submit" class="w-full py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                <span>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</span>
                <span>ğŸš€</span>
              </button>
            </form>
          {% else %}
             <div class="text-center py-10 bg-slate-50 rounded-2xl border border-dashed border-slate-300">
               <p class="text-slate-500 mb-2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ Ø­Ø§Ù„ÙŠ Ù„ØªØ¬Ø¯ÙŠØ¯Ù‡.</p>
               <button onclick="document.querySelector('[data-tab=new]').click()" class="text-indigo-600 font-bold hover:underline">Ø§Ù†ØªÙ‚Ù„ Ù„Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</button>
             </div>
          {% endif %}
        </div>

      <!-- Tab Content: New Subscription -->
      <div id="tab-new" class="{% if active_request_tab != 'new' %}hidden{% endif %} animate-fade-in">
        {{ plans_map|json_script:"plans-map" }}

        <!-- Plan Details Card -->
        <div class="mb-6 p-5 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl text-white shadow-lg relative overflow-hidden">
          <div class="relative z-10 flex justify-between items-center text-center">
            <div>
               <p class="text-indigo-200 text-xs mb-1">Ø§Ù„Ø³Ø¹Ø±</p>
               <p class="text-2xl font-bold"><span id="plan-price">â€”</span> <span class="text-xs font-normal opacity-70">Ø±.Ø³</span></p>
            </div>
            <div class="w-px h-10 bg-white/20"></div>
            <div>
               <p class="text-indigo-200 text-xs mb-1">Ø§Ù„Ù…Ø¯Ø©</p>
               <p class="text-xl font-bold"><span id="plan-duration">â€”</span> <span class="text-xs font-normal opacity-70">ÙŠÙˆÙ…</span></p>
            </div>
            <div class="w-px h-10 bg-white/20"></div>
            <div>
               <p class="text-indigo-200 text-xs mb-1">Ø§Ù„Ø´Ø§Ø´Ø§Øª</p>
               <p class="text-xl font-bold" id="plan-max-screens">â€”</p>
            </div>
          </div>
        </div>

        <form method="post" enctype="multipart/form-data" class="space-y-5">
          {% csrf_token %}
          <input type="hidden" name="action" value="new">
          
          <div class="space-y-1">
            <label class="block text-sm font-bold text-slate-700">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
            {{ new_form.plan }}
             {% if new_form.plan.errors %}
               <p class="text-xs text-red-500 mt-1">{{ new_form.plan.errors }}</p>
             {% endif %}
          </div>

          <div class="space-y-1">
            <label class="block text-sm font-bold text-slate-700">ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
            {{ new_form.receipt_image }}
             {% if new_form.receipt_image.errors %}
               <p class="text-xs text-red-500 mt-1">{{ new_form.receipt_image.errors }}</p>
             {% endif %}
          </div>

          <div class="space-y-1">
            <label class="block text-sm font-bold text-slate-700">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            {{ new_form.transfer_note }}
             {% if new_form.transfer_note.errors %}
               <p class="text-xs text-red-500 mt-1">{{ new_form.transfer_note.errors }}</p>
             {% endif %}
          </div>

          <button type="submit" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2">
            <span>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ</span>
            <span>âœ¨</span>
          </button>
        </form>
      </div>

    </div>
  </div>


  {# --- Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (History Table) --- #}
  <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mt-8">
     <div class="px-6 py-5 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
        <h4 class="font-bold text-slate-800">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
     </div>
     <div class="overflow-x-auto">
        <table class="w-full text-sm">
           <thead class="bg-slate-50 text-slate-500 font-medium">
              <tr>
                 <th class="px-6 py-4 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                 <th class="px-6 py-4 text-right">Ø§Ù„Ù†ÙˆØ¹</th>
                 <th class="px-6 py-4 text-right">Ø§Ù„Ø®Ø·Ø©</th>
                 <th class="px-6 py-4 text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                 <th class="px-6 py-4 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                 <th class="px-6 py-4 text-right">Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
              </tr>
           </thead>
           <tbody class="divide-y divide-slate-100">
            {% for r in subscription_requests %}
              <tr class="hover:bg-slate-50 transition-colors">
                 <td class="px-6 py-4 font-mono text-slate-600">{{ r.created_at|date:"Y-m-d" }}</td>
                 <td class="px-6 py-4 font-bold text-slate-800">{{ r.get_request_type_display }}</td>
                 <td class="px-6 py-4 text-slate-600">{{ r.plan.name }}</td>
                 <td class="px-6 py-4 font-mono text-slate-700">{{ r.amount }} Ø±.Ø³</td>
                 <td class="px-6 py-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold
                    {% if r.status == 'approved' %}bg-emerald-100 text-emerald-700
                    {% elif r.status == 'rejected' %}bg-rose-100 text-rose-700
                    {% elif r.status == 'under_review' %}bg-amber-100 text-amber-700
                    {% else %}bg-slate-100 text-slate-700{% endif %}">
                       {{ r.get_status_display }}
                    </span>
                 </td>
                 <td class="px-6 py-4">
                    {% if r.receipt_image %}
                       <a href="{{ r.receipt_image.url }}" target="_blank" class="inline-flex items-center gap-1 text-xs font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded transition">
                          <span>ğŸ‘ï¸</span> Ø¹Ø±Ø¶
                       </a>
                    {% else %}
                       <span class="text-slate-300">â€”</span>
                    {% endif %}
                 </td>
              </tr>
            {% empty %}
              <tr>
                 <td colspan="6" class="px-6 py-10 text-center text-slate-400 flex flex-col items-center justify-center gap-2">
                    <span class="text-3xl grayscale opacity-50">ğŸ“­</span>
                    <span>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚</span>
                 </td>
              </tr>
            {% endfor %}
           </tbody>
        </table>
     </div>
  </div>

</div>

<script>
  (function () {
    // --- Tabs Logic ---
    function setActiveTab(tab) {
      var renewal = document.getElementById('tab-renewal');
      var fresh = document.getElementById('tab-new');
      if (!renewal || !fresh) return;

      if (tab === 'new') {
        renewal.classList.add('hidden');
        fresh.classList.remove('hidden');
      } else {
        fresh.classList.add('hidden');
        renewal.classList.remove('hidden');
      }

      var btns = document.querySelectorAll('.request-tab-btn');
      btns.forEach(function (b) {
        var isActive = b.getAttribute('data-tab') === tab;
        if (isActive) {
          b.classList.add('bg-white', 'text-indigo-600', 'shadow-md', 'ring-1', 'ring-indigo-100');
          b.classList.remove('text-slate-500', 'hover:bg-slate-200');
        } else {
          b.classList.remove('bg-white', 'text-indigo-600', 'shadow-md', 'ring-1', 'ring-indigo-100');
          b.classList.add('text-slate-500', 'hover:bg-slate-200');
        }
      });
    }

    // Attach click handlers
    document.querySelectorAll('.request-tab-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        setActiveTab(btn.getAttribute('data-tab') || 'renewal');
      });
    });

    // --- Dynamic Plan Details (New Subscription) ---
    function updatePlanDetails() {
      var script = document.getElementById('plans-map');
      if (!script) return;
      var plans = {};
      try { plans = JSON.parse(script.textContent || '{}'); } catch (e) { plans = {}; }

      var select = document.querySelector('select[name="new-plan"]'); 
      if (!select) select = document.querySelector('#tab-new select');

      if (!select) return;

      var planId = select.value;
      var d = plans[String(planId)] || null;

      var priceEl = document.getElementById('plan-price');
      var durEl = document.getElementById('plan-duration');
      var maxEl = document.getElementById('plan-max-screens');
      if (!priceEl || !durEl || !maxEl) return;

      if (!d) {
        priceEl.textContent = 'â€”';
        durEl.textContent = 'â€”';
        maxEl.textContent = 'â€”';
        return;
      }

      priceEl.textContent = (d.price !== undefined && d.price !== null && d.price !== '') ? d.price : 'Ù…Ø¬Ø§Ù†ÙŠ';
      durEl.textContent = (d.duration_days !== undefined && d.duration_days !== null) ? String(d.duration_days) : 'â€”';
      maxEl.textContent = (d.max_screens !== undefined && d.max_screens !== null) ? String(d.max_screens) : 'ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯';
    }

    var planSelect = document.querySelector('select[name="new-plan"]') || document.querySelector('#tab-new select');
    if (planSelect) {
      planSelect.addEventListener('change', updatePlanDetails);
      updatePlanDetails();
    }

    // Initialize Tab
    setActiveTab('{% if active_request_tab == "new" %}new{% else %}renewal{% endif %}');
  })();

  // --- Copy Clipboard Tool ---
  function copyToClipboard(text, button) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        showCopyFeedback(button, true);
      }).catch(function() {
        fallbackCopy(text, button);
      });
    } else {
      fallbackCopy(text, button);
    }
  }

  function fallbackCopy(text, button) {
    var textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    try {
      var success = document.execCommand('copy');
      showCopyFeedback(button, success);
    } catch (e) {
      showCopyFeedback(button, false);
    }
    document.body.removeChild(textarea);
  }

  function showCopyFeedback(button, success) {
    var textSpan = button.querySelector('.copy-text');
    var originalText = textSpan ? textSpan.textContent : 'Ù†Ø³Ø®';
    
    if(textSpan) textSpan.textContent = success ? 'ØªÙ…!' : 'ÙØ´Ù„';
    button.classList.add(success ? 'bg-emerald-500' : 'bg-red-500', 'text-white');
    button.classList.remove('bg-white/10', 'text-emerald-300');
    
    setTimeout(function() {
      if(textSpan) textSpan.textContent = originalText;
      button.classList.remove(success ? 'bg-emerald-500' : 'bg-red-500', 'text-white');
      button.classList.add('bg-white/10', 'text-emerald-300');
    }, 2000);
  }
</script>

<style>
  @keyframes shimmer {
    100% { transform: translateX(-100%) skewX(-12deg); }
  }
  .animate-shimmer {
    animation: shimmer 2s infinite linear;
  }
  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-bounce-slow {
    animation: bounce 2s infinite;
  }
</style>
{% endblock %}
