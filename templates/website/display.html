{% load static %}
<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{{ school_name }} â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶</title>

  <!-- Ø®Ø· + Tailwind -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { cairo: ['Cairo','ui-sans-serif','system-ui'] },
          colors:{ glass: 'rgba(255,255,255,.06)' },
          boxShadow:{
            'glass-lg':'0 10px 35px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.06)'
          },
          keyframes:{
            fadeIn:{'0%':{opacity:0,transform:'translateY(8px)'},
                    '100%':{opacity:1,transform:'translateY(0)'}},
            pulseSoft:{'0%,100%':{opacity:.75},'50%':{opacity:1}},
            floatY:{'0%':{transform:'translateY(0)'},
                    '50%':{transform:'translateY(-6px)'},
                    '100%':{transform:'translateY(0)'}},
            spin:{to:{transform:'rotate(360deg)'}}
          },
          animation:{
            'fade-in':'fadeIn .35s ease-out',
            'pulse-soft':'pulseSoft 2s ease-in-out infinite',
            'float-y':'floatY 10s ease-in-out infinite',
            'spin-slow':'spin 14s linear infinite'
          }
        }
      }
    }
  </script>

  <style>
    html,body{height:100%;font-family:'Cairo',sans-serif}
    :root{
      --edge:22px; --r:22px; --glass:rgba(255,255,255,.06);
      --ring: rgba(255,255,255,.12); --ring-strong: rgba(255,255,255,.22);
    }
    @media (min-width:1600px){:root{--edge:32px}}
    .safe{padding:max(env(safe-area-inset-top),var(--edge)) max(env(safe-area-inset-right),var(--edge)) max(env(safe-area-inset-bottom),var(--edge)) max(env(safe-area-inset-left),var(--edge))}
    .glass{backdrop-filter:saturate(140%) blur(10px);background:var(--glass)}
    .ring-soft{box-shadow: inset 0 0 0 1px var(--ring);}
    .ring-strong{box-shadow: inset 0 0 0 1px var(--ring-strong);}
    .scrollbar-thin::-webkit-scrollbar{height:8px;width:8px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:9999px}

    /* Ø®Ù„ÙÙŠØ© Ù…Ø²Ø®Ø±ÙØ© */
    #bg::before, #bg::after{content:""; position:absolute; inset:0; pointer-events:none;}
    #bg::before{
      background:
        radial-gradient(800px 400px at 85% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(1000px 500px at 10% 80%, rgba(0,0,0,.15), transparent 60%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0 1px, transparent 1px 40px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.045) 0 1px, transparent 1px 40px);
      mask-image: radial-gradient(1800px 900px at 50% 50%, #000 70%, transparent 100%);
    }
    #bg::after{
      background:
        radial-gradient(140px 140px at 75% 30%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(120px 120px at 20% 70%, rgba(255,255,255,.09), transparent 60%),
        radial-gradient(160px 160px at 40% 50%, rgba(255,255,255,.07), transparent 60%);
      animation: float-y 24s ease-in-out infinite;
    }
    @media (prefers-reduced-motion: reduce){
      *{animation: none !important; transition: none !important}
    }

    /* Ø´Ø±Ø§Ø¦Ø­ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… */
    .mini-chip{display:inline-flex;flex-direction:column;gap:.15rem;padding:.6rem .8rem;border-radius:1rem;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08)}
    .mini-chip .t{font-size:.72rem;opacity:.95;letter-spacing:.02em}
    .mini-chip .v{font-weight:800;line-height:1.15;font-size:.98rem}
    .mini-chip.now{background:rgba(255,255,255,.28);border-color:rgba(255,255,255,.55);box-shadow:0 10px 28px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.2)}
    .mini-chip.break{background:linear-gradient(135deg, rgba(16,185,129,.25), rgba(16,185,129,.12));border-color:rgba(16,185,129,.45)}
    .mini-chip.break .t::before{content:"ğŸƒ ";}

    /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª â€” Ø§Ø±ØªÙØ§Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ + Ø¨Ø§Ø¯Ø¬ Ø¹Ø±Ø¨ÙŠ */
    .ann-card{border-radius:18px;padding:14px;position:relative;overflow:visible}
    .ann-slide{position:static;padding:16px;display:none;flex-direction:column;gap:.6rem;opacity:1}
    .ann-slide.active{display:block}
    .ann-badge{align-self:flex-start;font-size:.75rem;padding:.15rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.14)}
    .ann-dots{position:absolute;bottom:8px;left:0;right:0;display:flex;justify-content:center;gap:6px}
    .ann-dot{width:6px;height:6px;border-radius:999px;background:rgba(255,255,255,.25)}
    .ann-dot.active{background:#fff}
    /* ØªÙ„ÙˆÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ */
    .ann-badge[data-level="Ø¹Ø§Ø¬Ù„"]   { background:rgba(220,38,38,.25);  border-color:rgba(220,38,38,.45); }
    .ann-badge[data-level="ØªÙ†Ø¨ÙŠÙ‡"] { background:rgba(245,158,11,.25); border-color:rgba(245,158,11,.45); }
    .ann-badge[data-level="Ù…Ø¹Ù„ÙˆÙ…Ø©"]{ background:rgba(59,130,246,.25); border-color:rgba(59,130,246,.45); }
    .ann-badge[data-level="ØªÙ‡Ù†Ø¦Ø©"] { background:rgba(16,185,129,.25); border-color:rgba(16,185,129,.45); }

    /* Ù‚Ø³Ù… Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† â€” ØªØµÙ…ÙŠÙ… Ù…Ø®ØªÙ„Ù ÙˆÙ„Ø§ÙØª */
    .ex-wrap{position:relative;border-radius:22px;padding:18px;background:
      linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));}
    .ex-hero{
      position:relative; overflow:hidden; border-radius:20px;
      padding:16px;
      background: radial-gradient(400px 160px at 90% 10%, rgba(123,97,255,.28), transparent 60%),
                  radial-gradient(300px 180px at 10% 80%, rgba(59,130,246,.25), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow:0 12px 32px rgba(0,0,0,.28);
      border:1px solid rgba(123,97,255,.35);
    }
    .ex-avatar{position:relative;width:96px;height:96px;border-radius:999px;display:grid;place-items:center;background:rgba(255,255,255,.1)}
    .ex-avatar::after{content:"";position:absolute;inset:-8px;border-radius:999px;border:2px dashed rgba(123,97,255,.45);animation:spin 14s linear infinite}
    .ex-img{width:100%;height:100%;object-fit:cover;border-radius:999px}
    .ex-ribbon{position:absolute;top:12px;left:12px;background:linear-gradient(90deg,#f0b,#70f);padding:.25rem .6rem;border-radius:999px;font-weight:800;font-size:.75rem}

    /* Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â€” Ø£Ù„ÙˆØ§Ù† Ù…ØªÙ†Ø§ÙˆØ¨Ø© */
    .standby-viewport{max-height:42vh;overflow:hidden;position:relative}
    .standby-track{will-change:transform}
    .sb-blue   { background:linear-gradient(180deg, rgba(59,130,246,.18), rgba(59,130,246,.10)); border:1px solid rgba(59,130,246,.35); }
    .sb-emerald{ background:linear-gradient(180deg, rgba(16,185,129,.20), rgba(16,185,129,.10)); border:1px solid rgba(16,185,129,.40); }
    .sb-amber  { background:linear-gradient(180deg, rgba(245,158,11,.22),  rgba(245,158,11,.10));  border:1px solid rgba(245,158,11,.40); }
    .sb-rose   { background:linear-gradient(180deg, rgba(244,63,94,.18),  rgba(244,63,94,.10));   border:1px solid rgba(244,63,94,.35); }

    /* Skeleton */
    .skeleton{position:relative;overflow:hidden;background:rgba(255,255,255,.08)}
    .skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);animation:sk 1.2s infinite}
    @keyframes sk{to{transform:translateX(100%)}}
  </style>
</head>
<body class="min-h-full text-white safe" data-theme="{{ theme|default:'indigo' }}" data-media-prefix="{{ MEDIA_URL|default:'/media/' }}">
  <!-- Ø®Ù„ÙÙŠØ© -->
  <div id="bg" class="fixed inset-0 -z-10"></div>
  <script>
    (function(){
      const t=(document.body.dataset.theme||'indigo').toLowerCase();
      const p={indigo:['#1c266f','#6c8cff'],sky:['#0d3552','#52b6ff'],emerald:['#083b32','#45e0b5'],rose:['#4a0d2a','#ff6d9e'],amber:['#3b2b00','#ffb200'],slate:['#0b1023','#435a78']};
      const [c1,c2]=(p[t]||p.indigo);
      const el=document.getElementById('bg');
      el.style.background=`linear-gradient(135deg, ${c1} 0%, ${c2} 100%)`;
    })();
  </script>

  <!-- Ø´Ø§Ø±Ø© Ø§Ù„Ø´Ø¨ÙƒØ© -->
  <div id="net" class="fixed top-3 left-3 z-50 hidden px-3 py-1 rounded-full text-sm bg-red-600/90 shadow-lg ring-1 ring-white/20">ØºÙŠØ± Ù…ØªØµÙ„</div>

  <div class="mx-auto w-full max-w-[1920px] px-2 md:px-4">
    <!-- Ø§Ù„Ø±Ø£Ø³ -->
    <header class="flex flex-wrap items-center gap-4 py-4">
      {% if logo_url %}
        <img src="{{ logo_url }}" alt="Ø´Ø¹Ø§Ø±" class="h-14 w-14 md:h-16 md:w-16 object-contain rounded-xl ring-1 ring-white/10 bg-white/5 p-1 shadow-glass-lg">
      {% else %}
        <div class="h-14 w-14 md:h-16 md:w-16 grid place-items-center rounded-xl bg-white/5 ring-1 ring-white/10 shadow-glass-lg">ğŸ«</div>
      {% endif %}
      <div class="flex-1 min-w-[40%]">
        <h1 class="font-black drop-shadow-sm" style="font-size:clamp(26px,3.8vw,58px)">{{ school_name }}</h1>
        <div id="dateLine" class="inline-block mt-1 px-3 py-1 rounded-lg bg-white/10 ring-1 ring-white/20 text-slate-100 text-sm md:text-base">â€”</div>
      </div>
      <div class="text-right">
        <div id="clock" class="font-extrabold tabular-nums" style="font-size:clamp(20px,3vw,46px)">--:--:--</div>
        <div id="dayState" class="text-slate-200/80 text-sm">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦</div>
      </div>
    </header>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <main class="mt-4 grid grid-cols-12 gap-4 md:gap-6">
      <!-- Ø±Ø¦ÙŠØ³ÙŠ -->
      <section class="col-span-12 xl:col-span-8 2xl:col-span-9">
        <div class="rounded-[var(--r)] p-4 md:p-6 xl:p-7 shadow-2xl glass ring-soft h-full">
          <div class="flex items-center justify-between mb-4">
            <h2 id="heroTitle" class="font-extrabold" style="font-size:clamp(24px,3.2vw,50px)">â€”</h2>
            <span id="heroRange" class="font-bold text-white/90" style="font-size:clamp(14px,2.2vw,24px)">--:-- â†’ --:--</span>
          </div>

          <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… -->
          <div class="rounded-xl p-4 md:p-5 ring-soft bg-white/5 shadow-glass-lg">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div class="flex items-center gap-3">
                <span id="badgeKind" class="px-3 py-1 rounded-full bg-black/25 ring-soft text-sm md:text-base">â€”</span>
                <span class="text-white/80 text-sm md:text-base" id="nextLabel">Ø§Ù„ØªØ§Ù„ÙŠ: â€”</span>
              </div>

              <div class="relative h-24 w-24 md:h-28 md:w-28 shrink-0">
                <svg viewBox="0 0 120 120" class="h-full w-full -rotate-90">
                  <circle cx="60" cy="60" r="54" stroke-width="12" fill="none" class="stroke-white/15"></circle>
                  <circle id="circleProgress" cx="60" cy="60" r="54" stroke-linecap="round" stroke-width="12" fill="none" class="transition-all duration-500"></circle>
                </svg>
                <div class="absolute inset-0 grid place-items-center">
                  <div class="text-center leading-tight">
                    <div class="text-xs md:text-sm text-white/70">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                    <div id="countdown" class="font-black tabular-nums text-xl md:text-2xl">--:--</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-4 h-2 w-full bg-white/10 rounded-full overflow-hidden">
              <div id="progressBar" class="h-full bg-white/70 transition-[width] duration-500" style="width:0%"></div>
            </div>
          </div>

          <!-- Ø´Ø±Ø§Ø¦Ø­ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… -->
          <div class="mt-5 rounded-xl ring-soft bg-white/5 p-3 md:p-4 shadow-glass-lg">
            <div class="flex items-center justify-between mb-2">
              <div class="text-white/90 font-semibold">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</div>
              <div class="text-xs text-white/70">ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
            </div>
            <div id="miniSchedule" class="flex gap-2 overflow-x-auto scrollbar-thin pb-1">
              <!-- Skeleton Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
              <div class="mini-chip skeleton" style="min-width:10.5rem"></div>
              <div class="mini-chip skeleton" style="min-width:10.5rem"></div>
              <div class="mini-chip skeleton" style="min-width:10.5rem"></div>
            </div>
          </div>

          <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙˆÙ† (ØªØµÙ…ÙŠÙ… Ù…Ø®ØªÙ„Ù) -->
          <div class="mt-4 ex-wrap ring-soft shadow-glass-lg">
            <div class="flex items-center justify-between mb-3">
              <div class="text-lg font-extrabold tracking-wide">ğŸ–ï¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±ÙÙŠ </div>
              <div class="text-sm text-white/90"><span id="exIndex">0</span> / <span id="exTotal">0</span></div>
            </div>
            <div id="exSlot" class="min-h-[180px]">
              <!-- Skeleton -->
              <div class="ex-hero">
                <span class="ex-ribbon">Ù†Ø¬Ù… Ø§Ù„ÙŠÙˆÙ…</span>
                <div class="flex items-center gap-5">
                  <div class="ex-avatar skeleton"></div>
                  <div class="min-w-0 flex-1">
                    <div class="h-6 w-56 rounded skeleton mb-3"></div>
                    <div class="h-4 w-80 rounded skeleton"></div>
                  </div>
                </div>
              </div>
            </div>
            <div id="exEmpty" class="text-sm text-white/70 mt-2 hidden text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙ…ÙŠØ²ÙˆÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§.</div>
          </div>
        </div>
      </section>

      <!-- Ø¬Ø§Ù†Ø¨ÙŠ -->
      <aside class="col-span-12 xl:col-span-4 2xl:col-span-3 space-y-4 md:space-y-6">
        <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
        <div class="rounded-2xl p-4 md:p-5 ring-soft glass shadow-2xl">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg md:text-xl font-bold">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h3>
            <span id="annCount" class="text-slate-200/80 text-sm">0</span>
          </div>
          <div class="ann-card ring-soft" id="annCarousel">
            <!-- Skeleton -->
            <div class="w-full h-24 skeleton rounded-xl"></div>
          </div>
          <div class="ann-dots" id="annDots"></div>
          <div id="annEmpty" class="text-slate-300/80 text-sm mt-2">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ©.</div>
        </div>

        <!-- Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
        <div class="rounded-2xl p-4 md:p-5 ring-soft glass shadow-2xl">
          <div class="flex items-center justify-between">
            <h3 class="text-lg md:text-xl font-bold mb-3">Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø§Ù„ÙŠÙˆÙ…)</h3>
            <span class="text-xs text-white/70">ÙŠÙÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
          </div>
          <div class="standby-viewport">
            <div id="standbyTrack" class="standby-track">
              <!-- Skeleton -->
              <div class="space-y-2">
                <div class="rounded-xl h-12 skeleton"></div>
                <div class="rounded-xl h-12 skeleton"></div>
                <div class="rounded-xl h-12 skeleton"></div>
              </div>
            </div>
          </div>
          <div id="standbyEmpty" class="text-slate-300/80 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙƒÙ„ÙŠÙØ§Øª Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙŠÙˆÙ….</div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    const REFRESH_EVERY = {{ refresh_interval_sec|default:30 }};
    const api = {
      today: "/api/display/today/",
      standby: "/api/standby/today/",
      ann: "/api/announcements/active/",
      exc: "/api/announcements/excellence/",
    };
    const $ = id => document.getElementById(id);
    const fmt2 = n => String(n).padStart(2,'0');

    /* Ø³Ø§Ø¹Ø© + ØªØ§Ø±ÙŠØ® */
    function tickClock(dateInfo){
      const now=new Date();
      const arWeek = new Intl.DateTimeFormat('ar-SA',{weekday:'long'}).format(now);
      $("clock").textContent=`${fmt2(now.getHours())}:${fmt2(now.getMinutes())}:${fmt2(now.getSeconds())}`;
      if(dateInfo){
        const g=dateInfo.gregorian, h=dateInfo.hijri;
        $("dateLine").textContent=`${arWeek} â€” ${g.year}/${fmt2(g.month)}/${fmt2(g.day)} (Ù…) â€” ${h.year}/${fmt2(h.month)}/${fmt2(h.day)} (Ù‡Ù€)`;
      }
    }
    function netBadge(ok){ $("net").classList.toggle('hidden', ok); }

    /* Ø£Ø¯ÙˆØ§Øª ÙˆÙ‚Øª */
    function hmToDate(hm){ if(!hm) return null; const [h,m]=String(hm).split(':').map(Number); const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0); }
    function isEnded(endHM){ const end=hmToDate(endHM); return end ? (Date.now() >= end.getTime()) : false; }
    function isNowBetween(startHM, endHM){ const s=hmToDate(startHM), e=hmToDate(endHM), n=Date.now(); return (s && e) ? (n>=s.getTime() && n<e.getTime()) : false; }

    /* Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
    let countdownSeconds=null, progressRange={start:null,end:null};
    const circle = $("circleProgress"); let CIRC_TOTAL = 0;
    function setupCircle(){ if(!circle) return; const r = circle.r?.baseVal?.value || 54; CIRC_TOTAL = 2*Math.PI*r; circle.style.strokeDasharray = CIRC_TOTAL.toFixed(3); circle.style.strokeDashoffset = CIRC_TOTAL.toFixed(3); circle.style.stroke = "#ffffff"; circle.style.filter = "drop-shadow(0 0 6px rgba(255,255,255,.25))"; }
    function ringColor(pct){ if(pct>66) return "#10b981"; if(pct>33) return "#f59e0b"; return "#ef4444"; }
    function setRing(pct){ if(!circle || !CIRC_TOTAL) return; const clamped = Math.max(0, Math.min(100, pct)); const off = CIRC_TOTAL * (1 - clamped/100); circle.style.strokeDashoffset = off; circle.style.stroke = ringColor(clamped); }

    function startTicker(){
      setInterval(()=>{
        netBadge(navigator.onLine);
        tickClock();
        if (typeof countdownSeconds==='number'){
          if(countdownSeconds>0) countdownSeconds--;
          const mm=Math.floor(countdownSeconds/60), ss=countdownSeconds%60;
          $("countdown").textContent=`${fmt2(mm)}:${fmt2(ss)}`;
        } else $("countdown").textContent="--:--";

        if(progressRange.start && progressRange.end){
          const now=Date.now();
          const pct=Math.max(0,Math.min(100,((now-progressRange.start)/(progressRange.end-progressRange.start))*100));
          $("progressBar").style.width=`${pct.toFixed(1)}%`; setRing(pct);
        } else { $("progressBar").style.width="0%"; setRing(0); }
      },1000);
    }
    function toTimeStr(t){ if(!t) return "--:--"; const [h,m]=String(t).split(":"); return `${h}:${m}`; }

    /* ===== Ø§Ù„Ø­Ø§Ù„Ø© + Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… ===== */
    let _stateCache=null;
    function renderState(payload){
      const s=payload.state, day=payload.day;
      tickClock(payload.date_info);

      let title="â€”", range="--:-- â†’ --:--", badge="Ø§Ù„ÙŠÙˆÙ…";
      countdownSeconds=null; progressRange={start:null,end:null};

      if(s.type==="before"){
        title="Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…"; badge="Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§";
        if(s.next?.type==="period"){ range=`ØªØ¨Ø¯Ø£ ${toTimeStr(s.next.starts_at)}`; }
        if(typeof s.countdown_seconds==='number'){ countdownSeconds=s.countdown_seconds; }
      }else if(s.type==="after"){
        title="Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ"; badge="Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‚Ø§Ø¡";
      }else if(s.type==="break"){
        title="ÙØ³Ø­Ø©"; badge="Ø§Ø³ØªØ±Ø§Ø­Ø©";
        range=`${toTimeStr(s.current.starts_at)} â†’ ${toTimeStr(s.current.ends_at)}`;
        countdownSeconds=s.countdown_seconds??null;
        const [sh,sm]=String(s.current.starts_at).split(":").map(Number);
        const [eh,em]=String(s.current.ends_at).split(":").map(Number);
        const d=new Date(); progressRange={start:new Date(d.getFullYear(),d.getMonth(),d.getDate(),sh,sm,0).getTime(),end:new Date(d.getFullYear(),d.getMonth(),d.getDate(),eh,em,0).getTime()};
      }else if(s.type==="period"){
        title=`Ø§Ù„Ø­ØµÙ‘Ø© ${s.current.index}`; badge="Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­ØµÙ‘Ø©";
        range=`${toTimeStr(s.current.starts_at)} â†’ ${toTimeStr(s.current.ends_at)}`;
        countdownSeconds=s.countdown_seconds??null;
        const [sh,sm]=String(s.current.starts_at).split(":").map(Number);
        const [eh,em]=String(s.current.ends_at).split(":").map(Number);
        const d=new Date(); progressRange={start:new Date(d.getFullYear(),d.getMonth(),d.getDate(),sh,sm,0).getTime(),end:new Date(d.getFullYear(),d.getMonth(),d.getDate(),eh,em,0).getTime()};
      }
      $("heroTitle").textContent=title; $("heroRange").textContent=range; $("badgeKind").textContent=badge;

      $("nextLabel").textContent = s.next
        ? (s.next.type==="period" ? `Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ù„Ø­ØµÙ‘Ø© ${s.next.index} â€” ${toTimeStr(s.next.starts_at)}` : `Ø§Ù„ØªØ§Ù„ÙŠ: ${s.next.label||'ÙØ³Ø­Ø©'} â€” ${toTimeStr(s.next.starts_at)}`)
        : "Ø§Ù„ØªØ§Ù„ÙŠ: â€”";

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…
      const mini=$("miniSchedule"); mini.innerHTML="";
      const timeline=[];
      (day?.periods||[]).forEach(p=>timeline.push({kind:"period", start:p.starts_at, end:p.ends_at, label:`Ø§Ù„Ø­ØµÙ‘Ø© ${p.index}`}));
      (day?.breaks||[]).forEach(b=>timeline.push({kind:"break", start:b.starts_at, end:b.ends_at, label:b.label||"ÙØ³Ø­Ø©"}));
      timeline.sort((a,b)=>hmToDate(a.start)-hmToDate(b.start) || (a.kind==="period"?-1:1));

      const shown = s.type==="before" ? timeline : timeline.filter(x=>!isEnded(x.end));
      shown.forEach(x=>{
        const now = isNowBetween(x.start,x.end) ||
          (x.kind==="period" && s.type==="period" && s.current?.starts_at===x.start) ||
          (x.kind==="break"  && s.type==="break"  && s.current?.starts_at===x.start);
        const chip=document.createElement('div');
        chip.className="mini-chip"+(x.kind==="break"?" break":"")+(now?" now":"");
        chip.style.minWidth="10.5rem";
        chip.innerHTML=`<div class="t">${x.label}</div><div class="v">${toTimeStr(x.start)} â€” ${toTimeStr(x.end)}</div>`;
        mini.appendChild(chip);
      });

      _stateCache = s||{};
    }

    /* ===== Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ===== */
    const ANN_KEY="display:ann:v1", ANN_INT=6000;
    let annList=[], annIdx=0, annTimer=null;
    function annMakeKey(a){ return String(a.id ?? (a.level||'')+'|'+(a.title||'')+'|'+(a.body||'')).slice(0,200); }
    function annLoadState(){ try{ return JSON.parse(localStorage.getItem(ANN_KEY)||"null"); }catch(_){ return null; } }
    function annSaveState(){ try{ localStorage.setItem(ANN_KEY, JSON.stringify({idx:annIdx,at:Date.now(),interval:ANN_INT,keys:annList.map(annMakeKey)})); }catch(_){} }
    function levelAr(level){
      switch((level||'').toLowerCase()){
        case 'urgent':  return 'Ø¹Ø§Ø¬Ù„';
        case 'warning': return 'ØªÙ†Ø¨ÙŠÙ‡';
        case 'success': return 'ØªÙ‡Ù†Ø¦Ø©';
        case 'info':
        default:        return 'Ù…Ø¹Ù„ÙˆÙ…Ø©';
      }
    }
    function mountAnnouncements(items){
      annList = Array.isArray(items)? items : [];
      $("annCount").textContent = annList.length;
      $("annEmpty").classList.toggle('hidden', annList.length>0);
      const car=$("annCarousel"), dots=$("annDots");
      car.innerHTML=""; dots.innerHTML="";
      if(!annList.length){ if(annTimer) clearInterval(annTimer); return; }

      annList.forEach((a)=> {
        const s=document.createElement('div'); s.className='ann-slide';
        const lvl = levelAr(a.level);
        s.innerHTML= `
          <div class="ann-badge" data-level="${lvl}">${lvl}</div>
          <div class="font-bold text-[clamp(16px,1.6vw,22px)]">${a.title||''}</div>
          ${a.body?`<div class="text-sm opacity-95 leading-6 whitespace-pre-line">${a.body}</div>`:''}
        `;
        car.appendChild(s);
        const d=document.createElement('div'); d.className='ann-dot'; dots.appendChild(d);
      });

      function show(i){
        const slides=[...car.children], ds=[...dots.children];
        annIdx=(i+slides.length)%slides.length;
        slides.forEach((el,k)=>el.classList.toggle('active',k===annIdx));
        ds.forEach((el,k)=>el.classList.toggle('active',k===annIdx));
        annSaveState();
      }

      const st=annLoadState();
      if(st && st.keys?.length){
        const wantKey=st.keys[st.idx??0];
        const keysNow=annList.map(annMakeKey);
        let base = keysNow.indexOf(wantKey);
        base = base>=0 ? base : (st.idx||0)%keysNow.length;
        const elapsed = Math.max(0, Date.now() - Number(st.at||Date.now()));
        const steps = Math.floor(elapsed / Number(st.interval||ANN_INT));
        annIdx = (base + steps) % keysNow.length;
      } else annIdx=0;

      show(annIdx);
      if(annTimer) clearInterval(annTimer);
      annTimer=setInterval(()=>show(annIdx+1), ANN_INT);
    }

    /* ===== Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙˆÙ† (ØªØµÙ…ÙŠÙ… Ù…Ø®ØªÙ„Ù) ===== */
    const EX_INT=8000, EX_KEY="display:ex:v2";
    let exList=[], exPtr=0, exTimer=null;
    function resolveImageURL(raw){
      if(!raw) return ""; const s=String(raw).trim(); if(!s) return "";
      if(/^data:image\//i.test(s)||/^blob:/i.test(s)) return s;
      if(/^https?:\/\//i.test(s)) return s.replace(/^http:\/\//i,"//");
      if(s.startsWith('//')) return s;
      if(s.startsWith('/')) return s;
      const pref=document.body.dataset.mediaPrefix||'/media/'; return (pref.endsWith('/')?pref:pref+'/')+s.replace(/^\.?\/*/,'');
    }
    function pickImage(e){
      const t=e.teacher||{};
      const c=[e.image_src,e.photo_url,e.image_url,e.photo,e.image,e.avatar,t.photo_url,t.image_url,t.photo,t.image];
      for(const v of c){ const u=resolveImageURL(v); if(u) return u; }
      return "";
    }
    function exKey(it){ return String(it.id ?? it.teacher_id ?? it.teacher_name ?? it.name ?? it.teacher?.name ?? JSON.stringify(it)).trim(); }
    function exCardHTML(e){
      const src=pickImage(e);
      const name=(e.teacher_name||e.name||(e.teacher&&e.teacher.name)||'â€”');
      const reason=(e.reason||'').slice(0,240);
      const img = src
        ? `<img class="ex-img" src="${src}" alt="" loading="lazy" referrerpolicy="no-referrer"
             onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'ex-img grid place-items-center text-2xl',textContent:'ğŸ–ï¸'}))">`
        : `<div class="ex-img grid place-items-center text-2xl">ğŸ–ï¸</div>`;
      return `
      <div class="ex-hero animate-fade-in">
        <span class="ex-ribbon">Ù†Ø¬Ù… Ø§Ù„ÙŠÙˆÙ…</span>
        <div class="flex items-center gap-5">
          <div class="ex-avatar">${img}</div>
          <div class="min-w-0 flex-1">
            <div class="font-black text-[clamp(18px,1.9vw,26px)] truncate">${name}</div>
            ${reason?`<div class="text-sm opacity-95 leading-6 line-clamp-2">${reason}</div>`:''}
          </div>
        </div>
      </div>`;
    }
    function exLoad(){ try{ return JSON.parse(localStorage.getItem(EX_KEY)||"null"); }catch(_){ return null; } }
    function exSave(){ try{ localStorage.setItem(EX_KEY, JSON.stringify({ptr:exPtr, at:Date.now(), interval:EX_INT, keys:exList.map(exKey)})); }catch(_){ } }
    function renderExcellence(items){
      exList=(Array.isArray(items)?items:[]).filter(x=> (x.teacher_name||x.name||x.teacher?.name));
      $("exTotal").textContent=exList.length;
      $("exEmpty").classList.toggle('hidden', exList.length>0);
      const slot=$("exSlot"); slot.innerHTML="";
      if(!exList.length){ if(exTimer) clearInterval(exTimer); $("exIndex").textContent="0"; return; }

      const st=exLoad();
      if(st && st.keys?.length){
        const keysNow=exList.map(exKey);
        const want=st.keys[st.ptr??0];
        let base = keysNow.indexOf(want); if(base<0) base = (st.ptr||0)%keysNow.length;
        const elapsed = Math.max(0, Date.now()-Number(st.at||Date.now()));
        const steps = Math.floor(elapsed / Number(st.interval||EX_INT));
        exPtr = (base + steps) % keysNow.length;
      } else exPtr=0;

      function show(i){
        if(!exList.length) return;
        exPtr = (i+exList.length)%exList.length;
        $("exIndex").textContent = exPtr+1;
        slot.innerHTML = exCardHTML(exList[exPtr]);
        exSave();
      }
      show(exPtr);
      if(exTimer) clearInterval(exTimer);
      exTimer=setInterval(()=>show(exPtr+1), EX_INT);
    }

    /* ===== Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ===== */
    const SB_KEY="display:standby:v1";
    let sbList=[], sbSpeed=16; // px/sec
    let sbRAF=null, sbStartTime=0, sbBaseOffset=0, sbHeight=0;
    function sbLoad(){ try{ return JSON.parse(localStorage.getItem(SB_KEY)||"null"); }catch(_){ return null; } }
    function sbSave(){ try{ localStorage.setItem(SB_KEY, JSON.stringify({at:Date.now(), base:sbBaseOffset})); }catch(_){} }
    function standbyVisible(x){
      const s=_stateCache||{}; const p=Number(x.period_index||0);
      if(s.type==="after") return false;
      if(s.type==="before") return true;
      if(s.type==="period") return p>=Number(s.current?.index||0);
      if(s.type==="break")  return p>=Number(s.next?.index||0);
      return true;
    }
    function renderStandby(items){
      sbList=(Array.isArray(items)?items:[]).filter(standbyVisible);
      $("standbyEmpty").classList.toggle('hidden', sbList.length>0);
      const track=$("standbyTrack"); track.innerHTML="";
      if(!sbList.length){ cancelAnimationFrame(sbRAF); sbRAF=null; return; }

      const palette = ['sb-blue','sb-emerald','sb-amber','sb-rose'];
      const block = (x,i)=>`<div class="rounded-xl px-3 py-2 ring-soft ${palette[i % palette.length]}">
        <div class="text-xs md:text-sm text-white/80">Ø§Ù„Ø­ØµÙ‘Ø© ${x.period_index} â€” Ø§Ù„ÙØµÙ„ ${x.class_name}</div>
        <div class="font-semibold">${x.teacher_name}</div>
      </div>`;

      const html = sbList.map((x,i)=>block(x,i)).join('');
      track.innerHTML = `<div id="sbSetA" class="space-y-2">${html}</div><div id="sbSetB" class="space-y-2">${html}</div>`;

      const setA = document.getElementById('sbSetA');
      sbHeight = setA.getBoundingClientRect().height + 8;

      const st = sbLoad();
      if(st && Number.isFinite(st.base)){ sbBaseOffset = st.base % sbHeight; } else sbBaseOffset = 0;
      sbStartTime = performance.now();

      cancelAnimationFrame(sbRAF);
      function loop(t){
        const dt = (t - sbStartTime)/1000;
        const offset = (sbBaseOffset + sbSpeed*dt) % sbHeight;
        track.style.transform = `translateY(-${offset}px)`;
        sbRAF = requestAnimationFrame(loop);
      }
      sbRAF = requestAnimationFrame(loop);

      if(window._sbSaver) clearInterval(window._sbSaver);
      window._sbSaver = setInterval(()=>{
        const now = performance.now();
        const dt = (now - sbStartTime)/1000;
        sbBaseOffset = (sbBaseOffset + sbSpeed*dt) % sbHeight;
        sbStartTime = now;
        sbSave();
      }, 5000);
    }

    /* Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
    async function safeFetch(url){
      try{
        const r=await fetch(url,{headers:{'Accept':'application/json'}});
        if(!r.ok) throw new Error(r.status);
        return await r.json();
      }catch(e){ console.error('Fetch',url,e); netBadge(false); return null; }
    }
    async function refreshAll(){
      const d=await safeFetch(api.today);   if(d){ renderState(d); }
      const a=await safeFetch(api.ann);     if(a) mountAnnouncements(a.items||[]);
      const s=await safeFetch(api.standby); if(s) renderStandby(s.items||[]);
      const x=await safeFetch(api.exc);     if(x) renderExcellence(x.items||[]);
    }

    (function init(){
      setupCircle(); startTicker(); refreshAll();
      setInterval(refreshAll, Math.max(10,REFRESH_EVERY)*1000);
    })();
  </script>
</body>
</html>
