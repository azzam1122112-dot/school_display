{% load static %}
{% load l10n %}
<!doctype html>
<html lang="ar" dir="rtl" class="h-full antialiased">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{{ school_name }} â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø°ÙƒÙŠØ©</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['IBM Plex Sans Arabic', 'ui-sans-serif', 'system-ui'] },
          colors: {
            glass: 'rgba(255, 255, 255, 0.08)',
            'glass-border': 'rgba(255, 255, 255, 0.15)',
            theme: {
                primary: 'var(--c-primary)',
                secondary: 'var(--c-secondary)',
                soft: 'var(--c-bg-soft)',
                text: 'var(--c-text)',
                border: 'var(--c-border)',
            }
          },
          animation: {
            'blob': 'blob 20s infinite',
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.5s ease-out',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          }
        }
      }
    }
  </script>

  <style>
    :root {
        /* Default Indigo Theme */
        --c-primary: #6366f1;
        --c-secondary: #a855f7;
        --c-bg-soft: rgba(99, 102, 241, 0.2);
        --c-text: #c7d2fe;
        --c-border: rgba(129, 140, 248, 0.3);
    }

    body { background-color: #0f172a; color: #f8fafc; overflow: hidden; }
    
    /* Aurora Background */
    .aurora-bg { position: fixed; inset: 0; z-index: -10; background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%); }
    .blob { position: absolute; filter: blur(80px); opacity: 0.4; animation: blob 20s infinite alternate; }
    .blob-1 { top: 0; left: 0; width: 50vw; height: 50vw; background: #4f46e5; animation-delay: 0s; }
    .blob-2 { bottom: 0; right: 0; width: 50vw; height: 50vw; background: #0ea5e9; animation-delay: -5s; }
    .blob-3 { top: 50%; left: 50%; width: 40vw; height: 40vw; background: #8b5cf6; transform: translate(-50%, -50%); animation-delay: -10s; }

    /* Glassmorphism */
    .glass-panel {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
    
    .text-glow { text-shadow: 0 0 20px rgba(255,255,255,0.3); }
    .num-font { font-family: 'ui-monospace', 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace; font-variant-numeric: tabular-nums; }
    
    /* Standby Grid */
    .standby-viewport { overflow: hidden; position: relative; mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent); }
    .standby-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    
    /* Alert Transition */
    .alert-enter { opacity: 0; transform: translateY(10px); }
    .alert-enter-active { opacity: 1; transform: translateY(0); transition: all 0.5s ease; }
    .alert-exit { opacity: 1; transform: translateY(0); }
    .alert-exit-active { opacity: 0; transform: translateY(-10px); transition: all 0.5s ease; }
  </style>
</head>
<body class="flex flex-col h-screen p-4 md:p-6 gap-4 md:gap-6 selection:bg-indigo-500 selection:text-white">

  <!-- Background -->
  <div class="aurora-bg">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')] opacity-30"></div>
  </div>

  <!-- Header -->
  <header class="flex items-center justify-between glass-panel rounded-2xl p-4 shrink-0 z-10">
    <div class="flex items-center gap-4">
      {% if logo_url %}
        <img src="{{ logo_url }}" alt="Logo" class="h-16 w-16 object-contain drop-shadow-lg bg-white/5 rounded-xl p-1">
      {% else %}
        <div class="h-16 w-16 grid place-items-center bg-theme-soft rounded-xl border border-theme-border text-3xl">ğŸ«</div>
      {% endif %}
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-white text-glow">{{ school_name }}</h1>
        <div class="relative h-7 mt-1 overflow-hidden min-w-[200px]">
            <div id="dateGregorian" class="absolute top-0 right-0 transition-all duration-700 ease-out transform translate-y-0 opacity-100 text-slate-300 text-sm md:text-base font-medium whitespace-nowrap"></div>
            <div id="dateHijri" class="absolute top-0 right-0 transition-all duration-700 ease-out transform translate-y-8 opacity-0 text-slate-300 text-sm md:text-base font-medium whitespace-nowrap"></div>
        </div>
      </div>
    </div>

    <!-- Alerts Carousel -->
    <!-- Removed from header -->

    <div class="text-left flex flex-col items-end">
      <div id="clock" class="text-4xl md:text-5xl font-bold text-white num-font tracking-tight leading-none drop-shadow-glow">--:--</div>
      <div class="flex items-center gap-3 mt-2">
        <div id="wxChip" class="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full text-xs backdrop-blur-sm border border-white/10">
          <span class="animate-pulse">ğŸ“¡</span> ...
        </div>
      </div>
    </div>
  </header>

  <!-- Main Grid -->
  <main class="flex-1 grid grid-cols-12 gap-4 md:gap-6 min-h-0">
    
    <!-- Left Column: Excellence + Standby -->
    <aside class="col-span-12 lg:col-span-4 flex flex-col gap-4 md:gap-6 min-h-0 order-2 lg:order-1">
      
      <!-- Excellence Card (Animated) -->
      <div class="glass-panel rounded-2xl p-0 overflow-hidden shrink-0 h-56 relative group shadow-lg ring-1 ring-amber-500/20">
        <div id="exSlot" class="h-full bg-gradient-to-br from-slate-800 to-slate-900 relative">
          <div class="h-full flex items-center justify-center text-slate-400 text-sm">
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù...
          </div>
        </div>
        <!-- Badge -->
        <div class="absolute top-3 right-3 z-10">
            <span class="bg-amber-500/90 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg backdrop-blur-md flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                Ù†Ø¬Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            </span>
        </div>
        <!-- Counter -->
        <div class="absolute top-3 left-3 z-10 bg-black/40 px-2 py-1 rounded text-[10px] text-white/80">
            <span id="exIndex">1</span>/<span id="exTotal">1</span>
        </div>
      </div>

      <!-- Standby List (Scrolling Grid) -->
      <div class="glass-panel rounded-2xl p-4 flex-1 flex flex-col min-h-0 relative">
        <div class="flex items-center justify-between mb-3 shrink-0 border-b border-white/5 pb-3">
          <h3 class="font-bold text-lg flex items-center gap-2 text-theme-text">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Ø­ØµØµ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
          </h3>
          <span id="sbCount" class="text-xs text-slate-400 bg-white/5 px-2 py-1 rounded">0 Ø­ØµØ©</span>
        </div>
        
        <div class="standby-viewport flex-1 relative">
          <div id="standbyTrack" class="will-change-transform">
            <!-- Content injected here -->
            <div class="text-center text-slate-400 py-12 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ….</div>
          </div>
        </div>
      </div>

    </aside>

    <!-- Right Column: Hero + Schedule -->
    <section class="col-span-12 lg:col-span-8 flex flex-col gap-4 md:gap-6 min-h-0 order-1 lg:order-2">
      
      <!-- Hero Card (Dynamic Color) -->
      <div id="heroCard" class="glass-panel rounded-3xl p-6 md:p-8 flex-1 flex flex-col justify-center relative overflow-hidden group transition-colors duration-1000">
        <!-- Dynamic Background Glow -->
        <div id="heroGlow" class="absolute top-0 right-0 w-64 h-64 bg-theme-soft blur-[80px] rounded-full -translate-y-1/2 translate-x-1/2 transition-colors duration-1000"></div>

        <div class="flex flex-col gap-6 relative z-10 w-full h-full justify-center">
            <!-- Main Content Row -->
            <div class="flex items-center justify-between">
              <div class="space-y-3">
                <div class="flex items-center gap-3">
                  <span id="badgeKind" class="px-3 py-1 rounded-lg bg-theme-soft border border-theme-border text-theme-text text-sm font-semibold transition-colors duration-500">â€”</span>
                  <span id="heroRange" class="text-slate-400 font-medium num-font text-lg">--:-- â†’ --:--</span>
                </div>
                <h2 id="heroTitle" class="text-4xl md:text-6xl font-black text-white tracking-tight leading-tight text-glow transition-all duration-500">â€”</h2>
                <p id="nextLabel" class="text-xl text-slate-300 font-medium mt-2 flex items-center gap-2">
                  <span>Ø§Ù„ØªØ§Ù„ÙŠ: â€”</span>
                </p>
              </div>

              <!-- Countdown Circle -->
              <div class="relative w-32 h-32 md:w-44 md:h-44 flex-shrink-0">
                <svg class="w-full h-full -rotate-90 transform drop-shadow-2xl" viewBox="0 0 120 120">
                  <circle cx="60" cy="60" r="54" stroke="rgba(255,255,255,0.1)" stroke-width="8" fill="none" />
                  <circle id="circleProgress" cx="60" cy="60" r="54" stroke="url(#grad1)" stroke-width="8" fill="none" stroke-linecap="round" class="transition-all duration-1000 ease-linear" style="stroke-dasharray: 339.292; stroke-dashoffset: 339.292;" />
                  <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop id="gradStart" offset="0%" style="stop-color:var(--c-primary);stop-opacity:1" />
                      <stop id="gradEnd" offset="100%" style="stop-color:var(--c-secondary);stop-opacity:1" />
                    </linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                  <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
                  <span id="countdown" class="text-3xl md:text-4xl font-bold text-white num-font">--:--</span>
                </div>
              </div>
            </div>

            <!-- Alerts Section (New) -->
            <div id="alertContainer" class="hidden w-full h-16 relative overflow-hidden rounded-xl bg-black/20 border border-white/5 backdrop-blur-sm transition-all duration-500">
                <!-- Alerts injected here -->
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="absolute bottom-0 left-0 right-0 h-1.5 bg-white/5">
          <div id="progressBar" class="h-full bg-gradient-to-r from-theme-primary to-theme-secondary shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all duration-1000 ease-linear" style="width: 0%"></div>
        </div>
      </div>

      <!-- Schedule Strip -->
      <div class="glass-panel rounded-2xl p-4 overflow-hidden h-32 shrink-0 flex flex-col justify-center">
        <div class="flex items-center gap-2 mb-2 opacity-70 text-sm">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
          <span class="font-semibold">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</span>
        </div>
        <div id="miniSchedule" class="flex gap-3 overflow-x-auto pb-1 scrollbar-hide snap-x items-center h-full">
          <!-- Filled by JS -->
        </div>
      </div>
    </section>

  </main>

  <!-- Fullscreen Button -->
  <button id="fsBtn" class="fixed bottom-4 left-4 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white/50 hover:text-white transition z-50">
    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
  </button>

  <script>
    let REFRESH_EVERY = {{ refresh_interval_sec|default:30|unlocalize }};
    let STANDBY_SPEED = {{ standby_scroll_speed|default:0.8|unlocalize }};
    let mainTimer = null;
    let finishedPeriodIndices = new Set();
    
    const api = {
      today: "/api/display/today/",
      standby: "/api/standby/today/",
      ann: "/api/announcements/active/",
      exc: "/api/announcements/excellence/",
      settings: "/api/display/settings/",
    };
    const $ = id => document.getElementById(id);
    const fmt2 = n => String(n).padStart(2,'0');

    // --- Theme Logic ---
    const THEMES = {
        indigo: { p: '#6366f1', s: '#a855f7', soft: 'rgba(99, 102, 241, 0.2)', text: '#c7d2fe', b: 'rgba(129, 140, 248, 0.3)' },
        sky:    { p: '#0ea5e9', s: '#3b82f6', soft: 'rgba(14, 165, 233, 0.2)', text: '#bae6fd', b: 'rgba(56, 189, 248, 0.3)' },
        emerald:{ p: '#10b981', s: '#14b8a6', soft: 'rgba(16, 185, 129, 0.2)', text: '#a7f3d0', b: 'rgba(52, 211, 153, 0.3)' },
        rose:   { p: '#f43f5e', s: '#ec4899', soft: 'rgba(244, 63, 94, 0.2)',  text: '#fecdd3', b: 'rgba(251, 113, 133, 0.3)' },
        amber:  { p: '#f59e0b', s: '#f97316', soft: 'rgba(245, 158, 11, 0.2)',  text: '#fde68a', b: 'rgba(251, 191, 36, 0.3)' },
    };

    function applyTheme(name){
        const t = THEMES[name] || THEMES['indigo'];
        const r = document.documentElement.style;
        r.setProperty('--c-primary', t.p);
        r.setProperty('--c-secondary', t.s);
        r.setProperty('--c-bg-soft', t.soft);
        r.setProperty('--c-text', t.text);
        r.setProperty('--c-border', t.b);
    }

    // Persistence for rotation state
    const STATE_KEY = 'school_display_state';
    function saveState(){
        try { localStorage.setItem(STATE_KEY, JSON.stringify({annIdx, exPtr})); } catch(e){}
    }
    function loadState(){
        try{
            const s = JSON.parse(localStorage.getItem(STATE_KEY));
            if(s){
                if(Number.isInteger(s.annIdx)) annIdx = s.annIdx;
                if(Number.isInteger(s.exPtr)) exPtr = s.exPtr;
            }
        }catch(e){}
    }

    // Date Fix
    const AR_MONTHS = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const HIJRI_MONTHS = ["Ù…Ø­Ø±Ù…", "ØµÙØ±", "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„", "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø®Ø±", "Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰", "Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©", "Ø±Ø¬Ø¨", "Ø´Ø¹Ø¨Ø§Ù†", "Ø±Ù…Ø¶Ø§Ù†", "Ø´ÙˆØ§Ù„", "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©", "Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©"];

    /* --- Clock & Date --- */
    let showHijri = false;
    let cachedDateInfo = null;
    
    function toggleDateDisplay(){
        showHijri = !showHijri;
        const g = $("dateGregorian");
        const h = $("dateHijri");
        if(!g || !h) return;
        
        if(showHijri){
            // Show Hijri, Hide Gregorian (Slide Up)
            g.classList.remove('translate-y-0', 'opacity-100');
            g.classList.add('-translate-y-8', 'opacity-0');
            
            h.classList.remove('translate-y-8', 'opacity-0');
            h.classList.add('translate-y-0', 'opacity-100');
        } else {
            // Show Gregorian, Hide Hijri (Slide Down)
            g.classList.remove('-translate-y-8', 'opacity-0');
            g.classList.add('translate-y-0', 'opacity-100');
            
            h.classList.remove('translate-y-0', 'opacity-100');
            h.classList.add('translate-y-8', 'opacity-0');
        }
    }

    function tickClock(dateInfo){
      const now=new Date();
      const arWeek = new Intl.DateTimeFormat('ar-SA',{weekday:'long'}).format(now);
      $("clock").textContent=`${fmt2(now.getHours())}:${fmt2(now.getMinutes())}`;
      
      if(dateInfo) cachedDateInfo = dateInfo;
      
      if(cachedDateInfo){
        const g = cachedDateInfo.gregorian || {};
        const h = cachedDateInfo.hijri || {};
        const gMonth = g.month_name || AR_MONTHS[now.getMonth()] || g.month;
        const hMonth = h.month_name || (h.month ? HIJRI_MONTHS[h.month-1] : '') || h.month;
        
        const gText = `${arWeek} ØŒ ${g.day||now.getDate()} ${gMonth} ${g.year||now.getFullYear()}Ù…`;
        const hText = `${arWeek} ØŒ ${h.day||''} ${hMonth} ${h.year||''}Ù‡Ù€`;
        
        if($("dateGregorian")) $("dateGregorian").textContent = gText;
        if($("dateHijri")) $("dateHijri").textContent = hText;
      } else {
        const gMonth = AR_MONTHS[now.getMonth()];
        const gText = `${arWeek} ØŒ ${now.getDate()} ${gMonth} ${now.getFullYear()}Ù…`;
        if($("dateGregorian")) $("dateGregorian").textContent = gText;
      }
    }
    function netBadge(ok){ $("wxChip").style.opacity = ok ? 1 : 0.5; }

    /* --- Time Utils --- */
    function hmToDate(hm){ if(!hm) return null; const [h,m]=String(hm).split(':').map(Number); const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0); }
    function isEnded(endHM){ const end=hmToDate(endHM); return end ? (Date.now() >= end.getTime()) : false; }
    function isNowBetween(startHM, endHM){ const s=hmToDate(startHM), e=hmToDate(endHM), n=Date.now(); return (s && e) ? (n>=s.getTime() && n<e.getTime()) : false; }
    function toTimeStr(t){ if(!t) return "--:--"; const [h,m]=String(t).split(":"); return `${h}:${m}`; }

    /* --- Progress Circle --- */
    let countdownSeconds=null, progressRange={start:null,end:null};
    const circle = $("circleProgress"); let CIRC_TOTAL = 339.292;
    
    function setRing(pct){
      if(!circle) return;
      const clamped = Math.max(0, Math.min(100, pct));
      const off = CIRC_TOTAL * (1 - clamped/100);
      circle.style.strokeDashoffset = off;
    }

    function startTicker(){
      setInterval(()=>{
        netBadge(navigator.onLine);
        tickClock();
        
        if (typeof countdownSeconds==='number'){
          if(countdownSeconds>0) countdownSeconds--;
          const mm=Math.floor(countdownSeconds/60), ss=countdownSeconds%60;
          $("countdown").textContent=`${fmt2(mm)}:${fmt2(ss)}`;
        } else $("countdown").textContent="--:--";

        if(progressRange.start && progressRange.end){
          const now=Date.now();
          const pct=Math.max(0,Math.min(100,((now-progressRange.start)/(progressRange.end-progressRange.start))*100));
          $("progressBar").style.width=`${pct.toFixed(1)}%`; 
          setRing(pct);
        } else { 
          $("progressBar").style.width="0%"; 
          setRing(0); 
        }
      },1000);
    }

    /* --- State Renderer (With Break Colors) --- */
    let lastScheduleJSON = "";

    function renderState(payload){
      const s=payload.state, day=payload.day;
      const settings = payload.settings || {};
      
      // 1. Apply Theme
      if(settings.theme) applyTheme(settings.theme);

      // 2. Update Refresh Interval
      if(settings.refresh_interval_sec && settings.refresh_interval_sec !== REFRESH_EVERY){
          REFRESH_EVERY = settings.refresh_interval_sec;
          if(mainTimer) clearInterval(mainTimer);
          mainTimer = setInterval(refreshAll, Math.max(10, REFRESH_EVERY) * 1000);
      }
      
      // Update Scroll Speed
      if(settings.standby_scroll_speed && settings.standby_scroll_speed !== STANDBY_SPEED){
          STANDBY_SPEED = settings.standby_scroll_speed;
          // Restart scroll if active
          if(sbAnimFrame) startStandbyScroll();
      }

      tickClock(payload.date_info);

      // Populate finished periods for Standby filtering
      finishedPeriodIndices.clear();
      if(day && day.periods){
          day.periods.forEach(p => {
              if(isEnded(p.ends_at)) finishedPeriodIndices.add(Number(p.index));
          });
      }

      let title="â€”", range="--:-- â†’ --:--", badge="Ø§Ù„ÙŠÙˆÙ…";
      let isBreak = false;
      countdownSeconds=null; progressRange={start:null,end:null};

      if(s.type==="before"){
        title="ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±"; badge="Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±";
        if(s.next?.type==="period"){ range=`ØªØ¨Ø¯Ø£ ${toTimeStr(s.next.starts_at)}`; }
        if(typeof s.countdown_seconds==='number'){ countdownSeconds=s.countdown_seconds; }
      }else if(s.type==="off"){
        title="ÙŠÙˆÙ… Ø¥Ø¬Ø§Ø²Ø©"; badge="Ø¹Ø·Ù„Ø©";
        range="--:--";
        $("nextLabel").innerHTML = "Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… ÙŠÙˆÙ…Ø§Ù‹ Ø³Ø¹ÙŠØ¯Ø§Ù‹";
      }else if(s.type==="after"){
        title="Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¯ÙˆØ§Ù…"; badge="ÙÙŠ Ø£Ù…Ø§Ù† Ø§Ù„Ù„Ù‡";
      }else if(s.type==="break"){
        isBreak = true;
        title=s.current.label || "ÙØ³Ø­Ø© / ØµÙ„Ø§Ø©"; badge="Ø§Ø³ØªØ±Ø§Ø­Ø©";
        range=`${toTimeStr(s.current.starts_at)} â†’ ${toTimeStr(s.current.ends_at)}`;
        countdownSeconds=s.countdown_seconds??null;
        const [sh,sm]=String(s.current.starts_at).split(":").map(Number);
        const [eh,em]=String(s.current.ends_at).split(":").map(Number);
        const d=new Date(); progressRange={start:new Date(d.getFullYear(),d.getMonth(),d.getDate(),sh,sm,0).getTime(),end:new Date(d.getFullYear(),d.getMonth(),d.getDate(),eh,em,0).getTime()};
      }else if(s.type==="period"){
        title=`Ø§Ù„Ø­ØµÙ‘Ø© ${s.current.index}`; badge="Ø¯Ø±Ø³";
        range=`${toTimeStr(s.current.starts_at)} â†’ ${toTimeStr(s.current.ends_at)}`;
        countdownSeconds=s.countdown_seconds??null;
        const [sh,sm]=String(s.current.starts_at).split(":").map(Number);
        const [eh,em]=String(s.current.ends_at).split(":").map(Number);
        const d=new Date(); progressRange={start:new Date(d.getFullYear(),d.getMonth(),d.getDate(),sh,sm,0).getTime(),end:new Date(d.getFullYear(),d.getMonth(),d.getDate(),eh,em,0).getTime()};
      }
      
      // Update Text
      $("heroTitle").textContent=title; $("heroRange").textContent=range; $("badgeKind").textContent=badge;
      
      const nextLabel = $("nextLabel");
      nextLabel.innerHTML = "";
      if (s.next) {
          const span1 = document.createElement("span");
          span1.className = "opacity-70";
          span1.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ: ";
          nextLabel.appendChild(span1);

          const span2 = document.createElement("span");
          span2.className = "font-bold text-white mx-1";
          span2.textContent = s.next.type === "period" ? `Ø§Ù„Ø­ØµÙ‘Ø© ${s.next.index}` : (s.next.label || 'ÙØ³Ø­Ø©');
          nextLabel.appendChild(span2);

          const span3 = document.createElement("span");
          span3.className = "bg-white/10 px-1.5 rounded text-sm num-font";
          span3.textContent = toTimeStr(s.next.starts_at);
          nextLabel.appendChild(span3);
      } else {
          nextLabel.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ: â€”";
      }

      // Apply Break Colors (Override Theme if Break)
      // REMOVED: We now respect the user's selected theme even during breaks.
      // If you want to force green for breaks, uncomment the block below.
      /*
      const r = document.documentElement.style;
      if(isBreak){
        // Force Emerald for Break
        r.setProperty('--c-primary', '#10b981');
        r.setProperty('--c-secondary', '#14b8a6');
        r.setProperty('--c-bg-soft', 'rgba(16, 185, 129, 0.2)');
        r.setProperty('--c-text', '#a7f3d0');
        r.setProperty('--c-border', 'rgba(52, 211, 153, 0.3)');
      } else {
        if(settings.theme) applyTheme(settings.theme);
      }
      */
      // Ensure theme is applied (it's already applied at start of renderState, but just in case)
      if(settings.theme) applyTheme(settings.theme);

      // Mini Schedule (Optimized)
      const timeline=[];
      (day?.periods||[]).forEach(p=>timeline.push({kind:"period", start:p.starts_at, end:p.ends_at, label:`${p.index}`}));
      (day?.breaks||[]).forEach(b=>timeline.push({kind:"break", start:b.starts_at, end:b.ends_at, label:b.label||"ÙØ³Ø­Ø©"}));
      timeline.sort((a,b)=>hmToDate(a.start)-hmToDate(b.start) || (a.kind==="period"?-1:1));

      const shown = timeline.filter(x=>!isEnded(x.end));
      const currentScheduleJSON = JSON.stringify(shown);
      const mini=$("miniSchedule");

      // Rebuild only if structure changed
      if(currentScheduleJSON !== lastScheduleJSON){
          lastScheduleJSON = currentScheduleJSON;
          mini.innerHTML="";
          
          if(shown.length === 0) {
             mini.innerHTML = '<div class="text-white/50 text-sm p-2">Ø§Ù†ØªÙ‡Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</div>';
          } else {
            shown.forEach((x, i) => {
                const chip = document.createElement('div');
                chip.id = `sched-item-${i}`;
                chip.className = `flex-shrink-0 rounded-xl p-3 flex flex-col items-center justify-center min-w-[4.5rem] h-20 transition-all duration-300 bg-white/5 text-slate-300 border border-white/10`;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = "text-[10px] opacity-70 mb-1";
                timeSpan.textContent = toTimeStr(x.start);
                chip.appendChild(timeSpan);

                const labelSpan = document.createElement('span');
                labelSpan.className = "font-bold text-lg leading-none";
                labelSpan.textContent = x.kind === 'period' ? `Ø­ ${x.label}` : x.label;
                chip.appendChild(labelSpan);

                mini.appendChild(chip);
            });
          }
      }

      // Update active state
      if(shown.length > 0){
          shown.forEach((x, i) => {
            const el = document.getElementById(`sched-item-${i}`);
            if(!el) return;

            const isCurrent = isNowBetween(x.start,x.end);
            
            let cls = "flex-shrink-0 rounded-xl p-3 flex flex-col items-center justify-center min-w-[4.5rem] h-20 transition-all duration-300 ";
            if(isCurrent){
                // Active item: Pulse animation + Theme colors + Glow
                cls += "bg-theme-primary text-white ring-4 ring-theme-secondary/50 shadow-[0_0_20px_rgba(var(--c-primary),0.6)] scale-110 z-10";
            } else {
                cls += "bg-white/5 text-slate-300 border border-white/10 opacity-60";
            }
            
            if(el.className !== cls) el.className = cls;
          });
      }
    }

    /* --- Announcements (Rotating) --- */
    let annList=[], annIdx=0, annTimer=null;

    const LEVEL_STYLES = {
        urgent: {
            bg: "bg-red-500/20",
            text: "text-red-400",
            icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`
        },
        warning: {
            bg: "bg-amber-500/20",
            text: "text-amber-400",
            icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`
        },
        info: {
            bg: "bg-blue-500/20",
            text: "text-blue-400",
            icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`
        },
        success: {
            bg: "bg-green-500/20",
            text: "text-green-400",
            icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`
        }
    };
    
    function mountAnnouncements(items){
      const newItems = Array.isArray(items)? items : [];
      if(JSON.stringify(newItems) === JSON.stringify(annList)) return;
      
      annList = newItems;
      const container = $("alertContainer");
      
      if(!annList.length){ 
        container.classList.add('hidden');
        if(annTimer) { clearInterval(annTimer); annTimer=null; }
        return; 
      }
      
      container.classList.remove('hidden');
      
      if(!annTimer){
        showNextAnn();
        if(annList.length > 1){
            annTimer = setInterval(showNextAnn, 5000);
        }
      } else {
        if(annList.length <= 1){
            clearInterval(annTimer); annTimer=null;
            showNextAnn();
        }
      }
    }

    function showNextAnn(){
        if(!annList.length) return;
        annIdx = annIdx % annList.length; 
        const item = annList[annIdx];
        const style = LEVEL_STYLES[item.level] || LEVEL_STYLES.info;
        
        const container = $("alertContainer");
        const el = document.createElement('div');
        // Updated style for inside Hero Card
        el.className = "absolute inset-0 flex items-center justify-start px-6 alert-enter";
        
        const wrapper = document.createElement('div');
        wrapper.className = "flex items-center gap-3 w-full";
        
        const iconSpan = document.createElement('span');
        iconSpan.className = `flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full ${style.bg} ${style.text} animate-pulse`;
        iconSpan.innerHTML = style.icon; // Icons are trusted SVG strings defined in code
        
        const textDiv = document.createElement('div');
        textDiv.className = "flex flex-col md:flex-row md:items-center gap-1 md:gap-3 overflow-hidden";
        
        const titleSpan = document.createElement('span');
        titleSpan.className = "text-white font-bold text-lg whitespace-nowrap";
        titleSpan.textContent = item.title;
        
        textDiv.appendChild(titleSpan);
        
        if (item.body) {
            const separator = document.createElement('span');
            separator.className = "hidden md:inline text-white/40";
            separator.textContent = "|";
            
            const bodySpan = document.createElement('span');
            bodySpan.className = "text-white/70 text-sm md:text-base truncate";
            bodySpan.textContent = item.body;
            
            textDiv.appendChild(separator);
            textDiv.appendChild(bodySpan);
        }
        
        wrapper.appendChild(iconSpan);
        wrapper.appendChild(textDiv);
        el.appendChild(wrapper);
        
        if(container.firstElementChild){
            const old = container.firstElementChild;
            old.classList.remove('alert-enter', 'alert-enter-active');
            old.classList.add('alert-exit', 'alert-exit-active');
            setTimeout(()=>old.remove(), 500);
        }
        
        container.appendChild(el);
        void el.offsetWidth;
        el.classList.add('alert-enter-active');
        el.classList.remove('alert-enter');

        annIdx = (annIdx + 1) % annList.length;
        saveState();
    }

    /* --- Excellence --- */
    const EX_INT=8000;
    let exList=[], exPtr=0, exTimer=null;
    
    function resolveImageURL(raw){
      if(!raw) return ""; const s=String(raw).trim(); if(!s) return "";
      if(/^data:image\//i.test(s)||/^blob:/i.test(s)) return s;
      if(/^https?:\/\//i.test(s)) return s.replace(/^http:\/\//i,"//");
      const pref=document.body.dataset.mediaPrefix||'/media/'; return (pref.endsWith('/')?pref:pref+'/')+s.replace(/^\.?\/*/,'');
    }

    function renderExcellence(items){
      const newItems = (Array.isArray(items)?items:[]).filter(x=> (x.teacher_name||x.name||x.teacher?.name));
      if(JSON.stringify(newItems) === JSON.stringify(exList)) return;

      exList = newItems;
      $("exTotal").textContent=exList.length;
      const slot=$("exSlot"); 
      
      if(!exList.length){ 
        if(exTimer) { clearInterval(exTimer); exTimer=null; }
        slot.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙ…ÙŠØ²ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
        return; 
      }

      if(!exTimer){
        showExcellence(exPtr); 
        exTimer=setInterval(()=>showExcellence(exPtr+1), EX_INT);
      }
    }

    function showExcellence(i){
        if(!exList.length) return;
        exPtr = (i+exList.length)%exList.length;
        $("exIndex").textContent = exPtr+1;
        const e = exList[exPtr];
        const slot=$("exSlot");
        
        const t=e.teacher||{};
        const rawSrc=[e.image_src,e.photo_url,e.image_url,e.photo,e.image,e.avatar,t.photo_url,t.image_url,t.photo,t.image].find(v => v);
        const src = resolveImageURL(rawSrc);
        const name=(e.teacher_name||e.name||(e.teacher&&e.teacher.name)||'â€”');
        const reason=(e.reason||'').slice(0,100);

        slot.style.opacity = 0;
        setTimeout(() => {
            slot.innerHTML = ''; // Clear previous content
            
            const wrapper = document.createElement('div');
            wrapper.className = "relative h-full w-full bg-slate-900";
            
            if (src) {
                // Blurred Background
                const blurDiv = document.createElement('div');
                blurDiv.className = "absolute inset-0 overflow-hidden";
                const blurImg = document.createElement('img');
                blurImg.src = src;
                blurImg.className = "w-full h-full object-cover opacity-30 blur-xl scale-110";
                blurDiv.appendChild(blurImg);
                wrapper.appendChild(blurDiv);
                
                // Main Image
                const mainImg = document.createElement('img');
                mainImg.src = src;
                mainImg.className = "absolute inset-0 w-full h-full object-contain z-10";
                mainImg.alt = name;
                wrapper.appendChild(mainImg);
            } else {
                const fallbackDiv = document.createElement('div');
                fallbackDiv.className = "absolute inset-0 bg-gradient-to-br from-indigo-900 to-purple-900";
                wrapper.appendChild(fallbackDiv);
            }
            
            // Gradient Overlay
            const gradientOverlay = document.createElement('div');
            gradientOverlay.className = "absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent z-20";
            wrapper.appendChild(gradientOverlay);
            
            // Text Content
            const textContainer = document.createElement('div');
            textContainer.className = "absolute bottom-0 left-0 right-0 p-4 z-30";
            
            const nameDiv = document.createElement('div');
            nameDiv.className = "font-bold text-white text-xl leading-tight mb-1 drop-shadow-md";
            nameDiv.textContent = name;
            textContainer.appendChild(nameDiv);
            
            if (reason) {
                const reasonDiv = document.createElement('div');
                reasonDiv.className = "text-xs text-slate-200 line-clamp-2 drop-shadow";
                reasonDiv.textContent = reason;
                textContainer.appendChild(reasonDiv);
            }
            
            wrapper.appendChild(textContainer);
            slot.appendChild(wrapper);
            
            slot.style.opacity = 1;
        }, 300);
        saveState();
    }

    /* --- Standby (Grid + Scroll) --- */
    let sbAnimFrame = null;
    let lastStandbyJSON = "";
    let standbyItemsCache = [];

    function startStandbyScroll(){
        const track = $("standbyTrack");
        const viewport = document.querySelector('.standby-viewport');
        if(!track || !viewport) return;

        // Stop existing
        if(sbAnimFrame) cancelAnimationFrame(sbAnimFrame);
        sbAnimFrame = null;
        track.style.transform = 'translateY(0)';
        
        // Reset to single copy to measure
        while(track.children.length > 1){
            track.removeChild(track.lastElementChild);
        }
        
        const contentDiv = track.firstElementChild;
        if(!contentDiv) return;

        // Force layout update
        const contentHeight = contentDiv.offsetHeight;
        const viewHeight = viewport.offsetHeight;

        if(contentHeight > viewHeight){
            // Add clone for seamless loop
            const clone = contentDiv.cloneNode(true);
            clone.setAttribute('aria-hidden', 'true');
            track.appendChild(clone);

            let y = 0;
            const speed = STANDBY_SPEED; // Pixels per frame

            function loop(){
                y += speed;
                if(y >= contentHeight){
                    y = 0; // Seamless reset
                }
                track.style.transform = `translateY(-${y}px)`;
                sbAnimFrame = requestAnimationFrame(loop);
            }
            sbAnimFrame = requestAnimationFrame(loop);
        }
    }

    function renderStandby(items){
      const activeItems = (Array.isArray(items)?items:[]).filter(x => {
          if(!x.period_index) return true;
          return !finishedPeriodIndices.has(Number(x.period_index));
      });

      const sorted = activeItems.slice().sort((a,b)=>{
        const pa = Number(a.period_index||0), pb = Number(b.period_index||0);
        if (pa !== pb) return pa - pb;
        return (a.teacher_name||'').localeCompare((b.teacher_name||''));
      });

      const currentJSON = JSON.stringify(sorted);
      if(currentJSON === lastStandbyJSON) return;
      lastStandbyJSON = currentJSON;
      standbyItemsCache = sorted;

      $("sbCount").textContent = `${sorted.length} Ø­ØµØ©`;
      const track = $("standbyTrack");
      
      // Clear
      if(sbAnimFrame) cancelAnimationFrame(sbAnimFrame);
      track.innerHTML = '';
      track.style.transform = 'translateY(0)';

      if(!sorted.length){ 
        track.innerHTML = '<div class="text-center text-slate-500 py-12 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ….</div>';
        return; 
      }

      const block = (x)=> {
        const div = document.createElement('div');
        div.className = "bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col justify-between backdrop-blur-sm hover:bg-white/10 transition-colors";
        
        const header = document.createElement('div');
        header.className = "flex items-center justify-between mb-2";
        
        const periodBadge = document.createElement('div');
        periodBadge.className = "bg-theme-soft text-theme-text font-bold px-2 py-0.5 rounded text-sm num-font";
        periodBadge.textContent = `Ø­ ${x.period_index}`;
        
        const classBadge = document.createElement('div');
        classBadge.className = "text-[10px] text-slate-400 bg-black/20 px-2 py-0.5 rounded";
        classBadge.textContent = x.class_name;
        
        header.appendChild(periodBadge);
        header.appendChild(classBadge);
        
        const teacherName = document.createElement('div');
        teacherName.className = "font-semibold text-white text-sm truncate";
        teacherName.textContent = x.teacher_name;
        
        div.appendChild(header);
        div.appendChild(teacherName);
        
        return div;
      };

      const contentDiv = document.createElement('div');
      contentDiv.className = "standby-grid pb-4";
      
      sorted.forEach(item => {
          contentDiv.appendChild(block(item));
      });
      
      track.appendChild(contentDiv);

      // Start scroll after a brief delay to ensure layout
      setTimeout(startStandbyScroll, 100);
    }
    
    window.addEventListener('resize', () => {
        if(standbyItemsCache.length) startStandbyScroll();
    });

    /* --- Fetch & Init --- */
    async function safeFetch(url){
      try{
        const urlObj = new URL(url, window.location.origin);
        urlObj.searchParams.append('_t', Date.now());
        
        // Add Token if present in current URL
        const currentParams = new URLSearchParams(window.location.search);
        const token = currentParams.get('token');
        if(token) {
            urlObj.searchParams.append('token', token);
        }

        const r=await fetch(urlObj.toString(),{headers:{'Accept':'application/json'}});
        if(!r.ok) throw new Error(r.status);
        return await r.json();
      }catch(e){ console.error(e); netBadge(false); return null; }
    }

    let lastSettingsJSON = "";
    async function checkSettings(){
        const s = await safeFetch(api.settings);
        if(!s) return;
        // We only care about visual settings that require reload
        const relevant = {
            name: s.name,
            theme: s.theme,
            logo_url: s.logo_url,
            refresh_interval_sec: s.refresh_interval_sec,
            standby_scroll_speed: s.standby_scroll_speed
        };
        const current = JSON.stringify(relevant);
        
        // First run, just store
        if(!lastSettingsJSON){
            lastSettingsJSON = current;
            // Also apply theme dynamically if possible, but reload is safer for everything
            if(s.theme) applyTheme(s.theme);
            return;
        }

        if(current !== lastSettingsJSON){
            console.log("Settings changed, reloading...");
            window.location.reload();
        }
    }

    async function refreshAll(){
      await checkSettings();
      const [d,a,s,x] = await Promise.all([
        safeFetch(api.today),
        safeFetch(api.ann),
        safeFetch(api.standby),
        safeFetch(api.exc),
      ]);
      if(d) renderState(d);
      if(a) mountAnnouncements(a.items||[]);
      if(s) renderStandby(s.items||[]);
      if(x) renderExcellence(x.items||[]);
    }

    /* --- Weather --- */
    const RIYADH = { lat: 24.7136, lon: 46.6753 };
    const wxMap = { 0:'â˜€ï¸', 1:'ğŸŒ¤ï¸', 2:'â›…', 3:'â˜ï¸', 45:'ğŸŒ«ï¸', 61:'ğŸŒ§ï¸', 95:'â›ˆï¸' };
    async function wxFetch(){
      try{
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${RIYADH.lat}&longitude=${RIYADH.lon}&current=temperature_2m,weather_code&timezone=auto`);
        const j = await r.json();
        const cur = j.current;
        const icon = wxMap[cur.weather_code] || 'ğŸŒ¡ï¸';
        $('wxChip').innerHTML = `<span class="text-lg">${icon}</span> <span class="font-bold num-font">${Math.round(cur.temperature_2m)}Â°</span> <span class="text-xs opacity-70">Ø§Ù„Ø±ÙŠØ§Ø¶</span>`;
      }catch(e){ $('wxChip').textContent = 'â€”'; }
    }

    (function init(){
      loadState();
      startTicker(); refreshAll(); wxFetch();
      mainTimer = setInterval(refreshAll, Math.max(10,REFRESH_EVERY)*1000);
      setInterval(wxFetch, 600000);
      setInterval(toggleDateDisplay, 5000);
      $('fsBtn').onclick = () => {
        if(!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
      };
    })();
  </script>
</body>
</html>
